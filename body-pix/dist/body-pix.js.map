{"version":3,"file":"body-pix.js","sources":["../src/decode_part_map.ts","../src/base_model.ts","../src/mobilenet.ts","../src/keypoints.ts","../src/multi_person/util.ts","../src/multi_person/decode_multiple_masks_cpu.ts","../src/multi_person/decode_multiple_masks_webgl.ts","../src/multi_person/decode_instance_masks.ts","../src/multi_person/max_heap.ts","../src/multi_person/build_part_with_score_queue.ts","../src/multi_person/decode_pose.ts","../src/multi_person/decode_multiple_poses.ts","../src/resnet.ts","../src/saved_models.ts","../src/util.ts","../src/body_pix_model.ts","../src/blur.ts","../src/output_rendering_util.ts","../src/part_channels.ts","../src/version.ts"],"sourcesContent":["/**\r\n * @license\r\n * Copyright 2019 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport * as tf from '@tensorflow/tfjs-core';\r\n\r\n/**\r\n * Takes the sigmoid of the part heatmap output and generates a 2d one-hot\r\n * tensor with ones where the part's score has the maximum value.\r\n *\r\n * @param partHeatmapScores\r\n */\r\nfunction toFlattenedOneHotPartMap(partHeatmapScores: tf.Tensor3D): tf.Tensor2D {\r\n  const numParts = partHeatmapScores.shape[2];\r\n  const partMapLocations = partHeatmapScores.argMax(2);\r\n\r\n  const partMapFlattened = partMapLocations.reshape([-1]);\r\n\r\n  return tf.oneHot(partMapFlattened, numParts) as tf.Tensor2D;\r\n}\r\n\r\nfunction clipByMask2d(image: tf.Tensor2D, mask: tf.Tensor2D): tf.Tensor2D {\r\n  return image.mul(mask);\r\n}\r\n\r\n/**\r\n * Takes the sigmoid of the segmentation output, and generates a segmentation\r\n * mask with a 1 or 0 at each pixel where there is a person or not a person. The\r\n * segmentation threshold determines the threshold of a score for a pixel for it\r\n * to be considered part of a person.\r\n * @param segmentScores A 3d-tensor of the sigmoid of the segmentation output.\r\n * @param segmentationThreshold The minimum that segmentation values must have\r\n * to be considered part of the person.  Affects the generation of the\r\n * segmentation mask and the clipping of the colored part image.\r\n *\r\n * @returns A segmentation mask with a 1 or 0 at each pixel where there is a\r\n * person or not a person.\r\n */\r\nexport function toMaskTensor(\r\n    segmentScores: tf.Tensor2D, threshold: number): tf.Tensor2D {\r\n  return tf.tidy(\r\n      () =>\r\n          (segmentScores.greater(tf.scalar(threshold)).toInt() as tf.Tensor2D));\r\n}\r\n\r\n/**\r\n * Takes the sigmoid of the person and part map output, and returns a 2d tensor\r\n * of an image with the corresponding value at each pixel corresponding to the\r\n * part with the highest value. These part ids are clipped by the segmentation\r\n * mask. Wherever the a pixel is clipped by the segmentation mask, its value\r\n * will set to -1, indicating that there is no part in that pixel.\r\n * @param segmentScores A 3d-tensor of the sigmoid of the segmentation output.\r\n * @param partHeatmapScores A 3d-tensor of the sigmoid of the part heatmap\r\n * output. The third dimension corresponds to the part.\r\n *\r\n * @returns A 2d tensor of an image with the corresponding value at each pixel\r\n * corresponding to the part with the highest value. These part ids are clipped\r\n * by the segmentation mask.  It will have values of -1 for pixels that are\r\n * outside of the body and do not have a corresponding part.\r\n */\r\nexport function decodePartSegmentation(\r\n    segmentationMask: tf.Tensor2D,\r\n    partHeatmapScores: tf.Tensor3D): tf.Tensor2D {\r\n  const [partMapHeight, partMapWidth, numParts] = partHeatmapScores.shape;\r\n  return tf.tidy(() => {\r\n    const flattenedMap = toFlattenedOneHotPartMap(partHeatmapScores);\r\n    const partNumbers = tf.range(0, numParts, 1, 'int32').expandDims(1);\r\n\r\n    const partMapFlattened =\r\n        flattenedMap.matMul(partNumbers as tf.Tensor2D).toInt();\r\n\r\n    const partMap = partMapFlattened.reshape([partMapHeight, partMapWidth]);\r\n\r\n    const partMapShiftedUpForClipping = partMap.add(tf.scalar(1, 'int32'));\r\n\r\n    return clipByMask2d(\r\n               partMapShiftedUpForClipping as tf.Tensor2D, segmentationMask)\r\n        .sub(tf.scalar(1, 'int32'));\r\n  });\r\n}\r\n\r\nexport function decodeOnlyPartSegmentation(partHeatmapScores: tf.Tensor3D):\r\n    tf.Tensor2D {\r\n  const [partMapHeight, partMapWidth, numParts] = partHeatmapScores.shape;\r\n  return tf.tidy(() => {\r\n    const flattenedMap = toFlattenedOneHotPartMap(partHeatmapScores);\r\n    const partNumbers = tf.range(0, numParts, 1, 'int32').expandDims(1);\r\n\r\n    const partMapFlattened =\r\n        flattenedMap.matMul(partNumbers as tf.Tensor2D).toInt();\r\n\r\n    return partMapFlattened.reshape([partMapHeight, partMapWidth]);\r\n  });\r\n}\r\n","\r\n/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport * as tfconv from '@tensorflow/tfjs-converter';\r\nimport * as tf from '@tensorflow/tfjs-core';\r\nimport {BodyPixOutputStride} from './types';\r\n\r\n/**\r\n * BodyPix supports using various convolution neural network models\r\n * (e.g. ResNet and MobileNetV1) as its underlying base model.\r\n * The following BaseModel interface defines a unified interface for\r\n * creating such BodyPix base models. Currently both MobileNet (in\r\n * ./mobilenet.ts) and ResNet (in ./resnet.ts) implements the BaseModel\r\n * interface. New base models that conform to the BaseModel interface can be\r\n * added to BodyPix.\r\n */\r\nexport abstract class BaseModel {\r\n  constructor(\r\n      protected readonly model: tfconv.GraphModel,\r\n      public readonly outputStride: BodyPixOutputStride) {\r\n    const inputShape =\r\n        this.model.inputs[0].shape as [number, number, number, number];\r\n    tf.util.assert(\r\n        (inputShape[1] === -1) && (inputShape[2] === -1),\r\n        () => `Input shape [${inputShape[1]}, ${inputShape[2]}] ` +\r\n            `must both be equal to or -1`);\r\n  }\r\n\r\n  abstract preprocessInput(input: tf.Tensor3D): tf.Tensor3D;\r\n\r\n  /**\r\n   * Predicts intermediate Tensor representations.\r\n   *\r\n   * @param input The input RGB image of the base model.\r\n   * A Tensor of shape: [`inputResolution`, `inputResolution`, 3].\r\n   *\r\n   * @return A dictionary of base model's intermediate predictions.\r\n   * The returned dictionary should contains the following elements:\r\n   * - heatmapScores: A Tensor3D that represents the keypoint heatmap scores.\r\n   * - offsets: A Tensor3D that represents the offsets.\r\n   * - displacementFwd: A Tensor3D that represents the forward displacement.\r\n   * - displacementBwd: A Tensor3D that represents the backward displacement.\r\n   * - segmentation: A Tensor3D that represents the segmentation of all\r\n   * people.\r\n   * - longOffsets: A Tensor3D that represents the long offsets used for\r\n   * instance grouping.\r\n   * - partHeatmaps: A Tensor3D that represents the body part segmentation.\r\n   */\r\n  predict(input: tf.Tensor3D): {\r\n    heatmapScores: tf.Tensor3D,\r\n    offsets: tf.Tensor3D,\r\n    displacementFwd: tf.Tensor3D,\r\n    displacementBwd: tf.Tensor3D,\r\n    segmentation: tf.Tensor3D,\r\n    partHeatmaps: tf.Tensor3D,\r\n    longOffsets: tf.Tensor3D,\r\n    partOffsets: tf.Tensor3D\r\n  } {\r\n    return tf.tidy(() => {\r\n      const asFloat = this.preprocessInput(input.toFloat());\r\n      const asBatch = asFloat.expandDims(0);\r\n      const results = this.model.predict(asBatch) as tf.Tensor4D[];\r\n      const results3d: tf.Tensor3D[] = results.map(y => y.squeeze([0]));\r\n      const namedResults = this.nameOutputResults(results3d);\r\n\r\n      return {\r\n        heatmapScores: namedResults.heatmap.sigmoid(),\r\n        offsets: namedResults.offsets,\r\n        displacementFwd: namedResults.displacementFwd,\r\n        displacementBwd: namedResults.displacementBwd,\r\n        segmentation: namedResults.segmentation,\r\n        partHeatmaps: namedResults.partHeatmaps,\r\n        longOffsets: namedResults.longOffsets,\r\n        partOffsets: namedResults.partOffsets\r\n      };\r\n    });\r\n  }\r\n\r\n  // Because MobileNet and ResNet predict() methods output a different order for\r\n  // these values, we have a method that needs to be implemented to order them.\r\n  abstract nameOutputResults(results: tf.Tensor3D[]): {\r\n    heatmap: tf.Tensor3D,\r\n    offsets: tf.Tensor3D,\r\n    displacementFwd: tf.Tensor3D,\r\n    displacementBwd: tf.Tensor3D,\r\n    segmentation: tf.Tensor3D,\r\n    partHeatmaps: tf.Tensor3D,\r\n    longOffsets: tf.Tensor3D,\r\n    partOffsets: tf.Tensor3D\r\n  };\r\n\r\n  /**\r\n   * Releases the CPU and GPU memory allocated by the model.\r\n   */\r\n  dispose() {\r\n    this.model.dispose();\r\n  }\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport * as tf from '@tensorflow/tfjs-core';\r\n\r\nimport {BaseModel} from './base_model';\r\n\r\nexport class MobileNet extends BaseModel {\r\n  preprocessInput(input: tf.Tensor3D): tf.Tensor3D {\r\n    // Normalize the pixels [0, 255] to be between [-1, 1].\r\n    return tf.tidy(() => tf.div(input, 127.5).sub(1.0));\r\n  }\r\n\r\n  nameOutputResults(results: tf.Tensor3D[]) {\r\n    const [\r\n      offsets,\r\n      segmentation,\r\n      partHeatmaps,\r\n      longOffsets,\r\n      heatmap,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      partOffsets,\r\n  ] = results;\r\n    return {\r\n      offsets,\r\n      segmentation,\r\n      partHeatmaps,\r\n      longOffsets,\r\n      heatmap,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      partOffsets\r\n    };\r\n  }\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nexport type Tuple<T> = [T, T];\r\nexport type StringTuple = Tuple<string>;\r\nexport type NumberTuple = Tuple<number>;\r\n\r\nexport const PART_NAMES = [\r\n  'nose', 'leftEye', 'rightEye', 'leftEar', 'rightEar', 'leftShoulder',\r\n  'rightShoulder', 'leftElbow', 'rightElbow', 'leftWrist', 'rightWrist',\r\n  'leftHip', 'rightHip', 'leftKnee', 'rightKnee', 'leftAnkle', 'rightAnkle'\r\n];\r\n\r\nexport const NUM_KEYPOINTS = PART_NAMES.length;\r\n\r\nexport interface NumberDict {\r\n  [jointName: string]: number;\r\n}\r\n\r\nexport const PART_IDS =\r\n    PART_NAMES.reduce((result: NumberDict, jointName, i): NumberDict => {\r\n      result[jointName] = i;\r\n      return result;\r\n    }, {}) as NumberDict;\r\n\r\nconst CONNECTED_PART_NAMES: StringTuple[] = [\r\n  ['leftHip', 'leftShoulder'], ['leftElbow', 'leftShoulder'],\r\n  ['leftElbow', 'leftWrist'], ['leftHip', 'leftKnee'],\r\n  ['leftKnee', 'leftAnkle'], ['rightHip', 'rightShoulder'],\r\n  ['rightElbow', 'rightShoulder'], ['rightElbow', 'rightWrist'],\r\n  ['rightHip', 'rightKnee'], ['rightKnee', 'rightAnkle'],\r\n  ['leftShoulder', 'rightShoulder'], ['leftHip', 'rightHip']\r\n];\r\n\r\n/*\r\n * Define the skeleton. This defines the parent->child relationships of our\r\n * tree. Arbitrarily this defines the nose as the root of the tree, however\r\n * since we will infer the displacement for both parent->child and\r\n * child->parent, we can define the tree root as any node.\r\n */\r\nexport const POSE_CHAIN: StringTuple[] = [\r\n  ['nose', 'leftEye'], ['leftEye', 'leftEar'], ['nose', 'rightEye'],\r\n  ['rightEye', 'rightEar'], ['nose', 'leftShoulder'],\r\n  ['leftShoulder', 'leftElbow'], ['leftElbow', 'leftWrist'],\r\n  ['leftShoulder', 'leftHip'], ['leftHip', 'leftKnee'],\r\n  ['leftKnee', 'leftAnkle'], ['nose', 'rightShoulder'],\r\n  ['rightShoulder', 'rightElbow'], ['rightElbow', 'rightWrist'],\r\n  ['rightShoulder', 'rightHip'], ['rightHip', 'rightKnee'],\r\n  ['rightKnee', 'rightAnkle']\r\n];\r\n\r\nexport const CONNECTED_PART_INDICES = CONNECTED_PART_NAMES.map(\r\n    ([jointNameA, jointNameB]) =>\r\n        ([PART_IDS[jointNameA], PART_IDS[jointNameB]]));\r\n","/**\r\n * @license\r\n * Copyright 2019 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport {NUM_KEYPOINTS} from '../keypoints';\r\nimport {Padding, Part, TensorBuffer3D, Vector2D} from '../types';\r\n\r\nexport function getScale(\r\n    [height, width]: [number, number],\r\n    [inputResolutionY, inputResolutionX]: [number, number],\r\n    padding: Padding): [number, number] {\r\n  const {top: padT, bottom: padB, left: padL, right: padR} = padding;\r\n  const scaleY = inputResolutionY / (padT + padB + height);\r\n  const scaleX = inputResolutionX / (padL + padR + width);\r\n  return [scaleX, scaleY];\r\n}\r\n\r\nexport function getOffsetPoint(\r\n    y: number, x: number, keypoint: number, offsets: TensorBuffer3D): Vector2D {\r\n  return {\r\n    y: offsets.get(y, x, keypoint),\r\n    x: offsets.get(y, x, keypoint + NUM_KEYPOINTS)\r\n  };\r\n}\r\n\r\nexport function getImageCoords(\r\n    part: Part, outputStride: number, offsets: TensorBuffer3D): Vector2D {\r\n  const {heatmapY, heatmapX, id: keypoint} = part;\r\n  const {y, x} = getOffsetPoint(heatmapY, heatmapX, keypoint, offsets);\r\n  return {\r\n    x: part.heatmapX * outputStride + x,\r\n    y: part.heatmapY * outputStride + y\r\n  };\r\n}\r\n\r\nexport function fillArray<T>(element: T, size: number): T[] {\r\n  const result: T[] = new Array(size);\r\n\r\n  for (let i = 0; i < size; i++) {\r\n    result[i] = element;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nexport function clamp(a: number, min: number, max: number): number {\r\n  if (a < min) {\r\n    return min;\r\n  }\r\n  if (a > max) {\r\n    return max;\r\n  }\r\n  return a;\r\n}\r\n\r\nexport function squaredDistance(\r\n    y1: number, x1: number, y2: number, x2: number): number {\r\n  const dy = y2 - y1;\r\n  const dx = x2 - x1;\r\n  return dy * dy + dx * dx;\r\n}\r\n\r\nexport function addVectors(a: Vector2D, b: Vector2D): Vector2D {\r\n  return {x: a.x + b.x, y: a.y + b.y};\r\n}\r\n\r\nexport function clampVector(a: Vector2D, min: number, max: number): Vector2D {\r\n  return {y: clamp(a.y, min, max), x: clamp(a.x, min, max)};\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport {NUM_KEYPOINTS} from '../keypoints';\r\nimport {Padding, Pose} from '../types';\r\n\r\nimport {getScale} from './util';\r\n\r\ninterface Pair {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\nfunction computeDistance(embedding: Pair[], pose: Pose, minPartScore = 0.3) {\r\n  let distance = 0.0;\r\n  let numKpt = 0;\r\n  for (let p = 0; p < embedding.length; p++) {\r\n    if (pose.keypoints[p].score > minPartScore) {\r\n      numKpt += 1;\r\n      distance += (embedding[p].x - pose.keypoints[p].position.x) ** 2 +\r\n          (embedding[p].y - pose.keypoints[p].position.y) ** 2;\r\n    }\r\n  }\r\n  if (numKpt === 0) {\r\n    distance = Infinity;\r\n  } else {\r\n    distance = distance / numKpt;\r\n  }\r\n  return distance;\r\n}\r\n\r\nfunction convertToPositionInOuput(\r\n    position: Pair, [padT, padL]: [number, number],\r\n    [scaleX, scaleY]: [number, number], stride: number): Pair {\r\n  const y = Math.round(((padT + position.y + 1.0) * scaleY - 1.0) / stride);\r\n  const x = Math.round(((padL + position.x + 1.0) * scaleX - 1.0) / stride);\r\n  return {x, y};\r\n}\r\n\r\nfunction getEmbedding(\r\n    location: Pair, keypointIndex: number,\r\n    convertToPosition: (pair: Pair) => Pair, outputResolutionX: number,\r\n    longOffsets: Float32Array, refineSteps: number,\r\n    [height, width]: [number, number]): Pair {\r\n  const newLocation = convertToPosition(location);\r\n\r\n  const nn = newLocation.y * outputResolutionX + newLocation.x;\r\n  let dy = longOffsets[NUM_KEYPOINTS * (2 * nn) + keypointIndex];\r\n  let dx = longOffsets[NUM_KEYPOINTS * (2 * nn + 1) + keypointIndex];\r\n  let y = location.y + dy;\r\n  let x = location.x + dx;\r\n  for (let t = 0; t < refineSteps; t++) {\r\n    y = Math.min(y, height - 1);\r\n    x = Math.min(x, width - 1);\r\n    const newPos = convertToPosition({x, y});\r\n    const nn = newPos.y * outputResolutionX + newPos.x;\r\n    dy = longOffsets[NUM_KEYPOINTS * (2 * nn) + keypointIndex];\r\n    dx = longOffsets[NUM_KEYPOINTS * (2 * nn + 1) + keypointIndex];\r\n    y = y + dy;\r\n    x = x + dx;\r\n  }\r\n\r\n  return {x, y};\r\n}\r\n\r\nfunction matchEmbeddingToInstance(\r\n    location: Pair, longOffsets: Float32Array, poses: Pose[],\r\n    numKptForMatching: number, [padT, padL]: [number, number],\r\n    [scaleX, scaleY]: [number, number], outputResolutionX: number,\r\n    [height, width]: [number, number], stride: number,\r\n    refineSteps: number): number {\r\n  const embed: Pair[] = [];\r\n  const convertToPosition = (pair: Pair) =>\r\n      convertToPositionInOuput(pair, [padT, padL], [scaleX, scaleY], stride);\r\n\r\n  for (let keypointsIndex = 0; keypointsIndex < numKptForMatching;\r\n       keypointsIndex++) {\r\n    const embedding = getEmbedding(\r\n        location, keypointsIndex, convertToPosition, outputResolutionX,\r\n        longOffsets, refineSteps, [height, width]);\r\n\r\n    embed.push(embedding);\r\n  }\r\n\r\n  let kMin = -1;\r\n  let kMinDist = Infinity;\r\n  for (let k = 0; k < poses.length; k++) {\r\n    const dist = computeDistance(embed, poses[k]);\r\n    if (dist < kMinDist) {\r\n      kMin = k;\r\n      kMinDist = dist;\r\n    }\r\n  }\r\n  return kMin;\r\n}\r\n\r\nfunction getOutputResolution(\r\n    [inputResolutionY, inputResolutionX]: [number, number],\r\n    stride: number): [number, number] {\r\n  const outputResolutionX = Math.round((inputResolutionX - 1.0) / stride + 1.0);\r\n  const outputResolutionY = Math.round((inputResolutionY - 1.0) / stride + 1.0);\r\n  return [outputResolutionX, outputResolutionY];\r\n}\r\n\r\nexport function decodeMultipleMasksCPU(\r\n    segmentation: Uint8Array, longOffsets: Float32Array,\r\n    posesAboveScore: Pose[], height: number, width: number, stride: number,\r\n    [inHeight, inWidth]: [number, number], padding: Padding,\r\n    refineSteps: number, numKptForMatching = 5): Uint8Array[] {\r\n  const dataArrays =\r\n      posesAboveScore.map(x => new Uint8Array(height * width).fill(0));\r\n\r\n  const {top: padT, left: padL} = padding;\r\n\r\n  const [scaleX, scaleY] =\r\n      getScale([height, width], [inHeight, inWidth], padding);\r\n  const [outputResolutionX, ] =\r\n    getOutputResolution([inHeight, inWidth], stride);\r\n  for (let i = 0; i < height; i += 1) {\r\n    for (let j = 0; j < width; j += 1) {\r\n      const n = i * width + j;\r\n      const prob = segmentation[n];\r\n      if (prob === 1) {\r\n        const kMin = matchEmbeddingToInstance(\r\n            {x: j, y: i}, longOffsets, posesAboveScore, numKptForMatching,\r\n            [padT, padL], [scaleX, scaleY], outputResolutionX, [height, width],\r\n            stride, refineSteps);\r\n        if (kMin >= 0) {\r\n          dataArrays[kMin][n] = 1;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return dataArrays;\r\n}\r\n\r\nexport function decodeMultiplePartMasksCPU(\r\n    segmentation: Uint8Array, longOffsets: Float32Array,\r\n    partSegmentaion: Uint8Array, posesAboveScore: Pose[], height: number,\r\n    width: number, stride: number, [inHeight, inWidth]: [number, number],\r\n    padding: Padding, refineSteps: number,\r\n    numKptForMatching = 5): Int32Array[] {\r\n  const dataArrays =\r\n      posesAboveScore.map(x => new Int32Array(height * width).fill(-1));\r\n\r\n  const {top: padT, left: padL} = padding;\r\n\r\n  const [scaleX, scaleY] =\r\n      getScale([height, width], [inHeight, inWidth], padding);\r\n  const [outputResolutionX, ] =\r\n    getOutputResolution([inHeight, inWidth], stride);\r\n\r\n  for (let i = 0; i < height; i += 1) {\r\n    for (let j = 0; j < width; j += 1) {\r\n      const n = i * width + j;\r\n      const prob = segmentation[n];\r\n      if (prob === 1) {\r\n        const kMin = matchEmbeddingToInstance(\r\n            {x: j, y: i}, longOffsets, posesAboveScore, numKptForMatching,\r\n            [padT, padL], [scaleX, scaleY], outputResolutionX, [height, width],\r\n            stride, refineSteps);\r\n        if (kMin >= 0) {\r\n          dataArrays[kMin][n] = partSegmentaion[n];\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return dataArrays;\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport * as tf from '@tensorflow/tfjs-core';\r\n\r\nimport {NUM_KEYPOINTS} from '../keypoints';\r\nimport {Padding, Pose} from '../types';\r\nimport {getScale} from './util';\r\n\r\nexport function decodeMultipleMasksWebGl(\r\n    segmentation: tf.Tensor2D, longOffsets: tf.Tensor3D,\r\n    posesAboveScore: Pose[], height: number, width: number, stride: number,\r\n    [inHeight, inWidth]: [number, number], padding: Padding,\r\n    refineSteps: number, minKptScore: number,\r\n    maxNumPeople: number): tf.Tensor2D {\r\n  // The height/width of the image/canvas itself.\r\n  const [origHeight, origWidth] = segmentation.shape;\r\n  // The height/width of the output of the model.\r\n  const [outHeight, outWidth] = longOffsets.shape.slice(0, 2);\r\n\r\n  const shapedLongOffsets: tf.Tensor4D =\r\n      longOffsets.reshape([outHeight, outWidth, 2, NUM_KEYPOINTS]);\r\n\r\n  // Make pose tensor of shape [MAX_NUM_PEOPLE, NUM_KEYPOINTS, 3] where\r\n  // the last 3 coordinates correspond to the score, h and w coordinate of that\r\n  // keypoint.\r\n  const poseVals = new Float32Array(maxNumPeople * NUM_KEYPOINTS * 3).fill(0.0);\r\n  for (let i = 0; i < posesAboveScore.length; i++) {\r\n    const poseOffset = i * NUM_KEYPOINTS * 3;\r\n    const pose = posesAboveScore[i];\r\n    for (let kp = 0; kp < NUM_KEYPOINTS; kp++) {\r\n      const keypoint = pose.keypoints[kp];\r\n      const offset = poseOffset + kp * 3;\r\n      poseVals[offset] = keypoint.score;\r\n      poseVals[offset + 1] = keypoint.position.y;\r\n      poseVals[offset + 2] = keypoint.position.x;\r\n    }\r\n  }\r\n\r\n  const [scaleX, scaleY] =\r\n      getScale([height, width], [inHeight, inWidth], padding);\r\n\r\n  const posesTensor = tf.tensor(poseVals, [maxNumPeople, NUM_KEYPOINTS, 3]);\r\n\r\n  const {top: padT, left: padL} = padding;\r\n\r\n  const program: tf.webgl.GPGPUProgram = {\r\n    variableNames: ['segmentation', 'longOffsets', 'poses'],\r\n    outputShape: [origHeight, origWidth],\r\n    userCode: `\r\n    int convertToPositionInOutput(int pos, int pad, float scale, int stride) {\r\n      return round(((float(pos + pad) + 1.0) * scale - 1.0) / float(stride));\r\n    }\r\n\r\n    float convertToPositionInOutputFloat(\r\n        int pos, int pad, float scale, int stride) {\r\n      return ((float(pos + pad) + 1.0) * scale - 1.0) / float(stride);\r\n    }\r\n\r\n    float dist(float x1, float y1, float x2, float y2) {\r\n      return pow(x1 - x2, 2.0) + pow(y1 - y2, 2.0);\r\n    }\r\n\r\n    float sampleLongOffsets(float h, float w, int d, int k) {\r\n      float fh = fract(h);\r\n      float fw = fract(w);\r\n      int clH = int(ceil(h));\r\n      int clW = int(ceil(w));\r\n      int flH = int(floor(h));\r\n      int flW = int(floor(w));\r\n      float o11 = getLongOffsets(flH, flW, d, k);\r\n      float o12 = getLongOffsets(flH, clW, d, k);\r\n      float o21 = getLongOffsets(clH, flW, d, k);\r\n      float o22 = getLongOffsets(clH, clW, d, k);\r\n      float o1 = mix(o11, o12, fw);\r\n      float o2 = mix(o21, o22, fw);\r\n      return mix(o1, o2, fh);\r\n    }\r\n\r\n    int findNearestPose(int h, int w) {\r\n      float prob = getSegmentation(h, w);\r\n      if (prob < 1.0) {\r\n        return -1;\r\n      }\r\n\r\n      // Done(Tyler): convert from output space h/w to strided space.\r\n      float stridedH = convertToPositionInOutputFloat(\r\n        h, ${padT}, ${scaleY}, ${stride});\r\n      float stridedW = convertToPositionInOutputFloat(\r\n        w, ${padL}, ${scaleX}, ${stride});\r\n\r\n      float minDist = 1000000.0;\r\n      int iMin = -1;\r\n      for (int i = 0; i < ${maxNumPeople}; i++) {\r\n        float curDistSum = 0.0;\r\n        int numKpt = 0;\r\n        for (int k = 0; k < ${NUM_KEYPOINTS}; k++) {\r\n          float dy = sampleLongOffsets(stridedH, stridedW, 0, k);\r\n          float dx = sampleLongOffsets(stridedH, stridedW, 1, k);\r\n\r\n          float y = float(h) + dy;\r\n          float x = float(w) + dx;\r\n\r\n          for (int s = 0; s < ${refineSteps}; s++) {\r\n            int yRounded = round(min(y, float(${height - 1.0})));\r\n            int xRounded = round(min(x, float(${width - 1.0})));\r\n\r\n            float yStrided = convertToPositionInOutputFloat(\r\n              yRounded, ${padT}, ${scaleY}, ${stride});\r\n            float xStrided = convertToPositionInOutputFloat(\r\n              xRounded, ${padL}, ${scaleX}, ${stride});\r\n\r\n            float dy = sampleLongOffsets(yStrided, xStrided, 0, k);\r\n            float dx = sampleLongOffsets(yStrided, xStrided, 1, k);\r\n\r\n            y = y + dy;\r\n            x = x + dx;\r\n          }\r\n\r\n          float poseScore = getPoses(i, k, 0);\r\n          float poseY = getPoses(i, k, 1);\r\n          float poseX = getPoses(i, k, 2);\r\n          if (poseScore > ${minKptScore}) {\r\n            numKpt = numKpt + 1;\r\n            curDistSum = curDistSum + dist(x, y, poseX, poseY);\r\n          }\r\n        }\r\n        if (numKpt > 0 && curDistSum / float(numKpt) < minDist) {\r\n          minDist = curDistSum / float(numKpt);\r\n          iMin = i;\r\n        }\r\n      }\r\n      return iMin;\r\n    }\r\n\r\n    void main() {\r\n        ivec2 coords = getOutputCoords();\r\n        int nearestPose = findNearestPose(coords[0], coords[1]);\r\n        setOutput(float(nearestPose));\r\n      }\r\n  `\r\n  };\r\n  const webglBackend = tf.backend() as tf.webgl.MathBackendWebGL;\r\n  return webglBackend.compileAndRun(\r\n      program, [segmentation, shapedLongOffsets, posesTensor]);\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport * as tf from '@tensorflow/tfjs-core';\r\nimport {getBackend} from '@tensorflow/tfjs-core';\r\n\r\nimport {Padding, PartSegmentation, PersonSegmentation, Pose} from '../types';\r\n\r\nimport {decodeMultipleMasksCPU, decodeMultiplePartMasksCPU} from './decode_multiple_masks_cpu';\r\nimport {decodeMultipleMasksWebGl} from './decode_multiple_masks_webgl';\r\n\r\nexport function toPersonKSegmentation(\r\n    segmentation: tf.Tensor2D, k: number): tf.Tensor2D {\r\n  return tf.tidy(\r\n      () => (segmentation.equal(tf.scalar(k)).toInt() as tf.Tensor2D));\r\n}\r\n\r\nexport function toPersonKPartSegmentation(\r\n    segmentation: tf.Tensor2D, bodyParts: tf.Tensor2D, k: number): tf.Tensor2D {\r\n  return tf.tidy(\r\n      () => segmentation.equal(tf.scalar(k))\r\n                .toInt()\r\n                .mul(bodyParts.add(1))\r\n                .sub(1));\r\n}\r\n\r\nfunction isWebGlBackend() {\r\n  return getBackend() === 'webgl';\r\n}\r\n\r\nexport async function decodePersonInstanceMasks(\r\n    segmentation: tf.Tensor2D, longOffsets: tf.Tensor3D, poses: Pose[],\r\n    height: number, width: number, stride: number,\r\n    [inHeight, inWidth]: [number, number], padding: Padding, minPoseScore = 0.2,\r\n    refineSteps = 8, minKeypointScore = 0.3,\r\n    maxNumPeople = 10): Promise<PersonSegmentation[]> {\r\n  // Filter out poses with smaller score.\r\n  const posesAboveScore = poses.filter(pose => pose.score >= minPoseScore);\r\n\r\n  let personSegmentationsData: Uint8Array[];\r\n\r\n  if (isWebGlBackend()) {\r\n    const personSegmentations = tf.tidy(() => {\r\n      const masksTensor = decodeMultipleMasksWebGl(\r\n          segmentation, longOffsets, posesAboveScore, height, width, stride,\r\n          [inHeight, inWidth], padding, refineSteps, minKeypointScore,\r\n          maxNumPeople);\r\n\r\n      return posesAboveScore.map(\r\n          (_, k) => toPersonKSegmentation(masksTensor, k));\r\n    });\r\n\r\n    personSegmentationsData =\r\n        (await Promise.all(personSegmentations.map(mask => mask.data())) as\r\n         Uint8Array[]);\r\n\r\n    personSegmentations.forEach(x => x.dispose());\r\n  } else {\r\n    const segmentationsData = await segmentation.data() as Uint8Array;\r\n    const longOffsetsData = await longOffsets.data() as Float32Array;\r\n\r\n    personSegmentationsData = decodeMultipleMasksCPU(\r\n        segmentationsData, longOffsetsData, posesAboveScore, height, width,\r\n        stride, [inHeight, inWidth], padding, refineSteps);\r\n  }\r\n\r\n  return personSegmentationsData.map(\r\n      (data, i) => ({data, pose: posesAboveScore[i], width, height}));\r\n}\r\n\r\nexport async function decodePersonInstancePartMasks(\r\n    segmentation: tf.Tensor2D, longOffsets: tf.Tensor3D,\r\n    partSegmentation: tf.Tensor2D, poses: Pose[], height: number, width: number,\r\n    stride: number, [inHeight, inWidth]: [number, number], padding: Padding,\r\n    minPoseScore = 0.2, refineSteps = 8, minKeypointScore = 0.3,\r\n    maxNumPeople = 10): Promise<PartSegmentation[]> {\r\n  const posesAboveScore = poses.filter(pose => pose.score >= minPoseScore);\r\n\r\n  let partSegmentationsByPersonData: Int32Array[];\r\n\r\n  if (isWebGlBackend()) {\r\n    const partSegmentations = tf.tidy(() => {\r\n      const masksTensor = decodeMultipleMasksWebGl(\r\n          segmentation, longOffsets, posesAboveScore, height, width, stride,\r\n          [inHeight, inWidth], padding, refineSteps, minKeypointScore,\r\n          maxNumPeople);\r\n\r\n      return posesAboveScore.map(\r\n          (_, k) =>\r\n              toPersonKPartSegmentation(masksTensor, partSegmentation, k));\r\n    });\r\n\r\n    partSegmentationsByPersonData =\r\n        (await Promise.all(partSegmentations.map(x => x.data()))) as\r\n        Int32Array[];\r\n\r\n    partSegmentations.forEach(x => x.dispose());\r\n  } else {\r\n    const segmentationsData = await segmentation.data() as Uint8Array;\r\n    const longOffsetsData = await longOffsets.data() as Float32Array;\r\n    const partSegmentaionData = await partSegmentation.data() as Uint8Array;\r\n\r\n    partSegmentationsByPersonData = decodeMultiplePartMasksCPU(\r\n        segmentationsData, longOffsetsData, partSegmentaionData,\r\n        posesAboveScore, height, width, stride, [inHeight, inWidth], padding,\r\n        refineSteps);\r\n  }\r\n\r\n  return partSegmentationsByPersonData.map(\r\n      (data, k) => ({pose: posesAboveScore[k], data, height, width}));\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\n// algorithm based on Coursera Lecture from Algorithms, Part 1:\r\n// https://www.coursera.org/learn/algorithms-part1/lecture/ZjoSM/heapsort\r\n\r\nfunction half(k: number) {\r\n  return Math.floor(k / 2);\r\n}\r\n\r\nexport class MaxHeap<T> {\r\n  private priorityQueue: T[];\r\n  private numberOfElements: number;\r\n  private getElementValue: (element: T) => number;\r\n\r\n  constructor(maxSize: number, getElementValue: (element: T) => number) {\r\n    this.priorityQueue = new Array(maxSize);\r\n    this.numberOfElements = -1;\r\n    this.getElementValue = getElementValue;\r\n  }\r\n\r\n  public enqueue(x: T): void {\r\n    this.priorityQueue[++this.numberOfElements] = x;\r\n    this.swim(this.numberOfElements);\r\n  }\r\n\r\n  public dequeue(): T {\r\n    const max = this.priorityQueue[0];\r\n    this.exchange(0, this.numberOfElements--);\r\n    this.sink(0);\r\n    this.priorityQueue[this.numberOfElements + 1] = null;\r\n    return max;\r\n  }\r\n\r\n  public empty(): boolean {\r\n    return this.numberOfElements === -1;\r\n  }\r\n\r\n  public size(): number {\r\n    return this.numberOfElements + 1;\r\n  }\r\n\r\n  public all(): T[] {\r\n    return this.priorityQueue.slice(0, this.numberOfElements + 1);\r\n  }\r\n\r\n  public max(): T {\r\n    return this.priorityQueue[0];\r\n  }\r\n\r\n  private swim(k: number): void {\r\n    while (k > 0 && this.less(half(k), k)) {\r\n      this.exchange(k, half(k));\r\n      k = half(k);\r\n    }\r\n  }\r\n\r\n  private sink(k: number): void {\r\n    while (2 * k <= this.numberOfElements) {\r\n      let j = 2 * k;\r\n      if (j < this.numberOfElements && this.less(j, j + 1)) {\r\n        j++;\r\n      }\r\n      if (!this.less(k, j)) {\r\n        break;\r\n      }\r\n      this.exchange(k, j);\r\n      k = j;\r\n    }\r\n  }\r\n\r\n  private getValueAt(i: number): number {\r\n    return this.getElementValue(this.priorityQueue[i]);\r\n  }\r\n\r\n  private less(i: number, j: number): boolean {\r\n    return this.getValueAt(i) < this.getValueAt(j);\r\n  }\r\n\r\n  private exchange(i: number, j: number): void {\r\n    const t = this.priorityQueue[i];\r\n    this.priorityQueue[i] = this.priorityQueue[j];\r\n    this.priorityQueue[j] = t;\r\n  }\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport {PartWithScore, TensorBuffer3D} from '../types';\r\n\r\nimport {MaxHeap} from './max_heap';\r\n\r\nfunction scoreIsMaximumInLocalWindow(\r\n    keypointId: number, score: number, heatmapY: number, heatmapX: number,\r\n    localMaximumRadius: number, scores: TensorBuffer3D): boolean {\r\n  const [height, width] = scores.shape;\r\n\r\n  let localMaximum = true;\r\n  const yStart = Math.max(heatmapY - localMaximumRadius, 0);\r\n  const yEnd = Math.min(heatmapY + localMaximumRadius + 1, height);\r\n  for (let yCurrent = yStart; yCurrent < yEnd; ++yCurrent) {\r\n    const xStart = Math.max(heatmapX - localMaximumRadius, 0);\r\n    const xEnd = Math.min(heatmapX + localMaximumRadius + 1, width);\r\n    for (let xCurrent = xStart; xCurrent < xEnd; ++xCurrent) {\r\n      if (scores.get(yCurrent, xCurrent, keypointId) > score) {\r\n        localMaximum = false;\r\n        break;\r\n      }\r\n    }\r\n    if (!localMaximum) {\r\n      break;\r\n    }\r\n  }\r\n\r\n  return localMaximum;\r\n}\r\n\r\n/**\r\n * Builds a priority queue with part candidate positions for a specific image in\r\n * the batch. For this we find all local maxima in the score maps with score\r\n * values above a threshold. We create a single priority queue across all parts.\r\n */\r\nexport function buildPartWithScoreQueue(\r\n    scoreThreshold: number, localMaximumRadius: number,\r\n    scores: TensorBuffer3D): MaxHeap<PartWithScore> {\r\n  const [height, width, numKeypoints] = scores.shape;\r\n\r\n  const queue = new MaxHeap<PartWithScore>(\r\n      height * width * numKeypoints, ({score}) => score);\r\n\r\n  for (let heatmapY = 0; heatmapY < height; ++heatmapY) {\r\n    for (let heatmapX = 0; heatmapX < width; ++heatmapX) {\r\n      for (let keypointId = 0; keypointId < numKeypoints; ++keypointId) {\r\n        const score = scores.get(heatmapY, heatmapX, keypointId);\r\n\r\n        // Only consider parts with score greater or equal to threshold as\r\n        // root candidates.\r\n        if (score < scoreThreshold) {\r\n          continue;\r\n        }\r\n\r\n        // Only consider keypoints whose score is maximum in a local window.\r\n        if (scoreIsMaximumInLocalWindow(\r\n                keypointId, score, heatmapY, heatmapX, localMaximumRadius,\r\n                scores)) {\r\n          queue.enqueue({score, part: {heatmapY, heatmapX, id: keypointId}});\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return queue;\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport {NumberTuple, PART_IDS, PART_NAMES, POSE_CHAIN} from '../keypoints';\r\nimport {Keypoint, PartWithScore, TensorBuffer3D, Vector2D} from '../types';\r\n\r\nimport {clamp, getOffsetPoint} from './util';\r\nimport {addVectors, getImageCoords} from './util';\r\n\r\nconst parentChildrenTuples: NumberTuple[] = POSE_CHAIN.map(\r\n    ([parentJoinName, childJoinName]): NumberTuple =>\r\n        ([PART_IDS[parentJoinName], PART_IDS[childJoinName]]));\r\n\r\nconst parentToChildEdges: number[] =\r\n    parentChildrenTuples.map(([, childJointId]) => childJointId);\r\n\r\nconst childToParentEdges: number[] =\r\n    parentChildrenTuples.map(([\r\n                               parentJointId,\r\n                             ]) => parentJointId);\r\n\r\nfunction getDisplacement(\r\n    edgeId: number, point: Vector2D, displacements: TensorBuffer3D): Vector2D {\r\n  const numEdges = displacements.shape[2] / 2;\r\n  return {\r\n    y: displacements.get(point.y, point.x, edgeId),\r\n    x: displacements.get(point.y, point.x, numEdges + edgeId)\r\n  };\r\n}\r\n\r\nfunction getStridedIndexNearPoint(\r\n    point: Vector2D, outputStride: number, height: number,\r\n    width: number): Vector2D {\r\n  return {\r\n    y: clamp(Math.round(point.y / outputStride), 0, height - 1),\r\n    x: clamp(Math.round(point.x / outputStride), 0, width - 1)\r\n  };\r\n}\r\n\r\n/**\r\n * We get a new keypoint along the `edgeId` for the pose instance, assuming\r\n * that the position of the `idSource` part is already known. For this, we\r\n * follow the displacement vector from the source to target part (stored in\r\n * the `i`-t channel of the displacement tensor). The displaced keypoint\r\n * vector is refined using the offset vector by `offsetRefineStep` times.\r\n */\r\nfunction traverseToTargetKeypoint(\r\n    edgeId: number, sourceKeypoint: Keypoint, targetKeypointId: number,\r\n    scoresBuffer: TensorBuffer3D, offsets: TensorBuffer3D, outputStride: number,\r\n    displacements: TensorBuffer3D, offsetRefineStep = 2): Keypoint {\r\n  const [height, width] = scoresBuffer.shape;\r\n\r\n  // Nearest neighbor interpolation for the source->target displacements.\r\n  const sourceKeypointIndices = getStridedIndexNearPoint(\r\n      sourceKeypoint.position, outputStride, height, width);\r\n\r\n  const displacement =\r\n      getDisplacement(edgeId, sourceKeypointIndices, displacements);\r\n\r\n  const displacedPoint = addVectors(sourceKeypoint.position, displacement);\r\n  let targetKeypoint = displacedPoint;\r\n  for (let i = 0; i < offsetRefineStep; i++) {\r\n    const targetKeypointIndices =\r\n        getStridedIndexNearPoint(targetKeypoint, outputStride, height, width);\r\n\r\n    const offsetPoint = getOffsetPoint(\r\n        targetKeypointIndices.y, targetKeypointIndices.x, targetKeypointId,\r\n        offsets);\r\n\r\n    targetKeypoint = addVectors(\r\n        {\r\n          x: targetKeypointIndices.x * outputStride,\r\n          y: targetKeypointIndices.y * outputStride\r\n        },\r\n        {x: offsetPoint.x, y: offsetPoint.y});\r\n  }\r\n  const targetKeyPointIndices =\r\n      getStridedIndexNearPoint(targetKeypoint, outputStride, height, width);\r\n  const score = scoresBuffer.get(\r\n      targetKeyPointIndices.y, targetKeyPointIndices.x, targetKeypointId);\r\n\r\n  return {position: targetKeypoint, part: PART_NAMES[targetKeypointId], score};\r\n}\r\n\r\n/**\r\n * Follows the displacement fields to decode the full pose of the object\r\n * instance given the position of a part that acts as root.\r\n *\r\n * @return An array of decoded keypoints and their scores for a single pose\r\n */\r\nexport function decodePose(\r\n    root: PartWithScore, scores: TensorBuffer3D, offsets: TensorBuffer3D,\r\n    outputStride: number, displacementsFwd: TensorBuffer3D,\r\n    displacementsBwd: TensorBuffer3D): Keypoint[] {\r\n  const numParts = scores.shape[2];\r\n  const numEdges = parentToChildEdges.length;\r\n\r\n  const instanceKeypoints: Keypoint[] = new Array(numParts);\r\n  // Start a new detection instance at the position of the root.\r\n  const {part: rootPart, score: rootScore} = root;\r\n  const rootPoint = getImageCoords(rootPart, outputStride, offsets);\r\n\r\n  instanceKeypoints[rootPart.id] = {\r\n    score: rootScore,\r\n    part: PART_NAMES[rootPart.id],\r\n    position: rootPoint\r\n  };\r\n\r\n  // Decode the part positions upwards in the tree, following the backward\r\n  // displacements.\r\n  for (let edge = numEdges - 1; edge >= 0; --edge) {\r\n    const sourceKeypointId = parentToChildEdges[edge];\r\n    const targetKeypointId = childToParentEdges[edge];\r\n    if (instanceKeypoints[sourceKeypointId] &&\r\n        !instanceKeypoints[targetKeypointId]) {\r\n      instanceKeypoints[targetKeypointId] = traverseToTargetKeypoint(\r\n          edge, instanceKeypoints[sourceKeypointId], targetKeypointId, scores,\r\n          offsets, outputStride, displacementsBwd);\r\n    }\r\n  }\r\n\r\n  // Decode the part positions downwards in the tree, following the forward\r\n  // displacements.\r\n  for (let edge = 0; edge < numEdges; ++edge) {\r\n    const sourceKeypointId = childToParentEdges[edge];\r\n    const targetKeypointId = parentToChildEdges[edge];\r\n    if (instanceKeypoints[sourceKeypointId] &&\r\n        !instanceKeypoints[targetKeypointId]) {\r\n      instanceKeypoints[targetKeypointId] = traverseToTargetKeypoint(\r\n          edge, instanceKeypoints[sourceKeypointId], targetKeypointId, scores,\r\n          offsets, outputStride, displacementsFwd);\r\n    }\r\n  }\r\n\r\n  return instanceKeypoints;\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport {Keypoint, Pose, TensorBuffer3D} from '../types';\r\n\r\nimport {buildPartWithScoreQueue} from './build_part_with_score_queue';\r\nimport {decodePose} from './decode_pose';\r\nimport {getImageCoords, squaredDistance} from './util';\r\n\r\nfunction withinNmsRadiusOfCorrespondingPoint(\r\n    poses: Pose[], squaredNmsRadius: number, {x, y}: {x: number, y: number},\r\n    keypointId: number): boolean {\r\n  return poses.some(({keypoints}) => {\r\n    const correspondingKeypoint = keypoints[keypointId].position;\r\n    return squaredDistance(\r\n               y, x, correspondingKeypoint.y, correspondingKeypoint.x) <=\r\n        squaredNmsRadius;\r\n  });\r\n}\r\n\r\n/* Score the newly proposed object instance without taking into account\r\n * the scores of the parts that overlap with any previously detected\r\n * instance.\r\n */\r\nfunction getInstanceScore(\r\n    existingPoses: Pose[], squaredNmsRadius: number,\r\n    instanceKeypoints: Keypoint[]): number {\r\n  let notOverlappedKeypointScores = instanceKeypoints.reduce(\r\n      (result, {position, score}, keypointId): number => {\r\n        if (!withinNmsRadiusOfCorrespondingPoint(\r\n                existingPoses, squaredNmsRadius, position, keypointId)) {\r\n          result += score;\r\n        }\r\n        return result;\r\n      }, 0.0);\r\n\r\n  return notOverlappedKeypointScores /= instanceKeypoints.length;\r\n}\r\n\r\n// A point (y, x) is considered as root part candidate if its score is a\r\n// maximum in a window |y - y'| <= kLocalMaximumRadius, |x - x'| <=\r\n// kLocalMaximumRadius.\r\nconst kLocalMaximumRadius = 1;\r\n\r\n/**\r\n * Detects multiple poses and finds their parts from part scores and\r\n * displacement vectors. It returns up to `maxDetections` object instance\r\n * detections in decreasing root score order. It works as follows: We first\r\n * create a priority queue with local part score maxima above\r\n * `scoreThreshold`, considering all parts at the same time. Then we\r\n * iteratively pull the top  element of the queue (in decreasing score order)\r\n * and treat it as a root candidate for a new object instance. To avoid\r\n * duplicate detections, we reject the root candidate if it is within a disk\r\n * of `nmsRadius` pixels from the corresponding part of a previously detected\r\n * instance, which is a form of part-based non-maximum suppression (NMS). If\r\n * the root candidate passes the NMS check, we start a new object instance\r\n * detection, treating the corresponding part as root and finding the\r\n * positions of the remaining parts by following the displacement vectors\r\n * along the tree-structured part graph. We assign to the newly detected\r\n * instance a score equal to the sum of scores of its parts which have not\r\n * been claimed by a previous instance (i.e., those at least `nmsRadius`\r\n * pixels away from the corresponding part of all previously detected\r\n * instances), divided by the total number of parts `numParts`.\r\n *\r\n * @param heatmapScores 3-D tensor with shape `[height, width, numParts]`.\r\n * The value of heatmapScores[y, x, k]` is the score of placing the `k`-th\r\n * object part at position `(y, x)`.\r\n *\r\n * @param offsets 3-D tensor with shape `[height, width, numParts * 2]`.\r\n * The value of [offsets[y, x, k], offsets[y, x, k + numParts]]` is the\r\n * short range offset vector of the `k`-th  object part at heatmap\r\n * position `(y, x)`.\r\n *\r\n * @param displacementsFwd 3-D tensor of shape\r\n * `[height, width, 2 * num_edges]`, where `num_edges = num_parts - 1` is the\r\n * number of edges (parent-child pairs) in the tree. It contains the forward\r\n * displacements between consecutive part from the root towards the leaves.\r\n *\r\n * @param displacementsBwd 3-D tensor of shape\r\n * `[height, width, 2 * num_edges]`, where `num_edges = num_parts - 1` is the\r\n * number of edges (parent-child pairs) in the tree. It contains the backward\r\n * displacements between consecutive part from the root towards the leaves.\r\n *\r\n * @param outputStride The output stride that was used when feed-forwarding\r\n * through the PoseNet model.  Must be 32, 16, or 8.\r\n *\r\n * @param maxPoseDetections Maximum number of returned instance detections per\r\n * image.\r\n *\r\n * @param scoreThreshold Only return instance detections that have root part\r\n * score greater or equal to this value. Defaults to 0.5.\r\n *\r\n * @param nmsRadius Non-maximum suppression part distance. It needs to be\r\n * strictly positive. Two parts suppress each other if they are less than\r\n * `nmsRadius` pixels away. Defaults to 20.\r\n *\r\n * @return An array of poses and their scores, each containing keypoints and\r\n * the corresponding keypoint scores.\r\n */\r\nexport function decodeMultiplePoses(\r\n    scoresBuffer: TensorBuffer3D, offsetsBuffer: TensorBuffer3D,\r\n    displacementsFwdBuffer: TensorBuffer3D,\r\n    displacementsBwdBuffer: TensorBuffer3D, outputStride: number,\r\n    maxPoseDetections: number, scoreThreshold = 0.5, nmsRadius = 20): Pose[] {\r\n  const poses: Pose[] = [];\r\n\r\n  const queue = buildPartWithScoreQueue(\r\n      scoreThreshold, kLocalMaximumRadius, scoresBuffer);\r\n\r\n  const squaredNmsRadius = nmsRadius * nmsRadius;\r\n\r\n  // Generate at most maxDetections object instances per image in\r\n  // decreasing root part score order.\r\n  while (poses.length < maxPoseDetections && !queue.empty()) {\r\n    // The top element in the queue is the next root candidate.\r\n    const root = queue.dequeue();\r\n\r\n    // Part-based non-maximum suppression: We reject a root candidate if it\r\n    // is within a disk of `nmsRadius` pixels from the corresponding part of\r\n    // a previously detected instance.\r\n    const rootImageCoords =\r\n        getImageCoords(root.part, outputStride, offsetsBuffer);\r\n    if (withinNmsRadiusOfCorrespondingPoint(\r\n            poses, squaredNmsRadius, rootImageCoords, root.part.id)) {\r\n      continue;\r\n    }\r\n\r\n    // Start a new detection instance at the position of the root.\r\n    const keypoints = decodePose(\r\n        root, scoresBuffer, offsetsBuffer, outputStride, displacementsFwdBuffer,\r\n        displacementsBwdBuffer);\r\n\r\n    const score = getInstanceScore(poses, squaredNmsRadius, keypoints);\r\n\r\n    poses.push({keypoints, score});\r\n  }\r\n\r\n  return poses;\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * https://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport * as tf from '@tensorflow/tfjs-core';\r\n\r\nimport {BaseModel} from './base_model';\r\n\r\nconst imageNetMean = [-123.15, -115.90, -103.06];\r\n\r\nexport class ResNet extends BaseModel {\r\n  preprocessInput(input: tf.Tensor3D): tf.Tensor3D {\r\n    return input.add(imageNetMean);\r\n  }\r\n\r\n  nameOutputResults(results: tf.Tensor3D[]) {\r\n    const [\r\n      displacementBwd,\r\n      displacementFwd,\r\n      heatmap,\r\n      longOffsets,\r\n      offsets,\r\n      partHeatmaps,\r\n      segmentation,\r\n      partOffsets,\r\n  ] = results;\r\n    return {\r\n      offsets,\r\n      segmentation,\r\n      partHeatmaps,\r\n      longOffsets,\r\n      heatmap,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      partOffsets\r\n    };\r\n  }\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * https://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nconst RESNET50_BASE_URL =\r\n    'https://storage.googleapis.com/tfjs-models/savedmodel/bodypix/resnet50/';\r\nconst MOBILENET_BASE_URL =\r\n    'https://storage.googleapis.com/tfjs-models/savedmodel/bodypix/mobilenet/';\r\n\r\n// The BodyPix 2.0 ResNet50 models use the latest TensorFlow.js 1.0 model\r\n// format.\r\nexport function resNet50SavedModel(stride: number, quantBytes: number): string {\r\n  const graphJson = `model-stride${stride}.json`;\r\n  // quantBytes=4 corresponding to the non-quantized full-precision SavedModel.\r\n  if (quantBytes === 4) {\r\n    return RESNET50_BASE_URL + `float/` + graphJson;\r\n  } else {\r\n    return RESNET50_BASE_URL + `quant${quantBytes}/` + graphJson;\r\n  }\r\n}\r\n\r\n// The BodyPix 2.0 MobileNetV1 models use the latest TensorFlow.js 1.0 model\r\n// format.\r\nexport function mobileNetSavedModel(\r\n    stride: number, multiplier: number, quantBytes: number): string {\r\n  const toStr: {[key: number]: string} = {1.0: '100', 0.75: '075', 0.50: '050'};\r\n  const graphJson = `model-stride${stride}.json`;\r\n  // quantBytes=4 corresponding to the non-quantized full-precision SavedModel.\r\n  if (quantBytes === 4) {\r\n    return MOBILENET_BASE_URL + `float/${toStr[multiplier]}/` + graphJson;\r\n  } else {\r\n    return MOBILENET_BASE_URL + `quant${quantBytes}/${toStr[multiplier]}/` +\r\n        graphJson;\r\n  }\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2020 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n *\r\n * =============================================================================\r\n */\r\n\r\nimport * as tf from '@tensorflow/tfjs-core';\r\n\r\nimport {BodyPixInput, BodyPixOutputStride, Padding} from './types';\r\nimport {Pose, TensorBuffer3D} from './types';\r\nimport {BodyPixInternalResolution} from './types';\r\n\r\nfunction getSizeFromImageLikeElement(input: HTMLImageElement|\r\n                                     HTMLCanvasElement): [number, number] {\r\n  if (input.offsetHeight !== 0 && input.offsetWidth !== 0) {\r\n    return [input.offsetHeight, input.offsetWidth];\r\n  } else if (input.height != null && input.width != null) {\r\n    return [input.height, input.width];\r\n  } else {\r\n    throw new Error(\r\n        `HTMLImageElement must have height and width attributes set.`);\r\n  }\r\n}\r\n\r\nfunction getSizeFromVideoElement(input: HTMLVideoElement): [number, number] {\r\n  if (input.height != null && input.width != null) {\r\n    // Prioritizes user specified height and width.\r\n    return [input.height, input.width];\r\n  } else {\r\n    return [input.videoHeight, input.videoWidth];\r\n  }\r\n}\r\n\r\nexport function getInputSize(input: BodyPixInput): [number, number] {\r\n  if ((typeof (HTMLCanvasElement) !== 'undefined' &&\r\n       input instanceof HTMLCanvasElement) ||\r\n      (typeof (HTMLImageElement) !== 'undefined' &&\r\n       input instanceof HTMLImageElement)) {\r\n    return getSizeFromImageLikeElement(input);\r\n  } else if (typeof (ImageData) !== 'undefined' && input instanceof ImageData) {\r\n    return [input.height, input.width];\r\n  } else if (\r\n      typeof (HTMLVideoElement) !== 'undefined' &&\r\n      input instanceof HTMLVideoElement) {\r\n    return getSizeFromVideoElement(input);\r\n  } else if (input instanceof tf.Tensor) {\r\n    return [input.shape[0], input.shape[1]];\r\n  } else {\r\n    throw new Error(`error: Unknown input type: ${input}.`);\r\n  }\r\n}\r\n\r\nfunction isValidInputResolution(\r\n    resolution: number, outputStride: number): boolean {\r\n  return (resolution - 1) % outputStride === 0;\r\n}\r\n\r\nexport function toValidInputResolution(\r\n    inputResolution: number, outputStride: BodyPixOutputStride): number {\r\n  if (isValidInputResolution(inputResolution, outputStride)) {\r\n    return inputResolution;\r\n  }\r\n\r\n  return Math.floor(inputResolution / outputStride) * outputStride + 1;\r\n}\r\n\r\nconst INTERNAL_RESOLUTION_STRING_OPTIONS = {\r\n  low: 'low',\r\n  medium: 'medium',\r\n  high: 'high',\r\n  full: 'full'\r\n};\r\n\r\nconst INTERNAL_RESOLUTION_PERCENTAGES = {\r\n  [INTERNAL_RESOLUTION_STRING_OPTIONS.low]: 0.25,\r\n  [INTERNAL_RESOLUTION_STRING_OPTIONS.medium]: 0.5,\r\n  [INTERNAL_RESOLUTION_STRING_OPTIONS.high]: 0.75,\r\n  [INTERNAL_RESOLUTION_STRING_OPTIONS.full]: 1.0\r\n};\r\n\r\nconst MIN_INTERNAL_RESOLUTION = 0.1;\r\nconst MAX_INTERNAL_RESOLUTION = 2.0;\r\n\r\nfunction toInternalResolutionPercentage(\r\n    internalResolution: BodyPixInternalResolution): number {\r\n  if (typeof internalResolution === 'string') {\r\n    const result = INTERNAL_RESOLUTION_PERCENTAGES[internalResolution];\r\n\r\n    tf.util.assert(\r\n        typeof result === 'number',\r\n        () => `string value of inputResolution must be one of ${\r\n            Object.values(INTERNAL_RESOLUTION_STRING_OPTIONS)\r\n                .join(',')} but was ${internalResolution}.`);\r\n    return result;\r\n  } else {\r\n    tf.util.assert(\r\n        typeof internalResolution === 'number' &&\r\n            internalResolution <= MAX_INTERNAL_RESOLUTION &&\r\n            internalResolution >= MIN_INTERNAL_RESOLUTION,\r\n        () =>\r\n            `inputResolution must be a string or number between ${\r\n                MIN_INTERNAL_RESOLUTION} and ${MAX_INTERNAL_RESOLUTION}, but ` +\r\n            `was ${internalResolution}`);\r\n\r\n    return internalResolution;\r\n  }\r\n}\r\n\r\nexport function toInputResolutionHeightAndWidth(\r\n    internalResolution: BodyPixInternalResolution,\r\n    outputStride: BodyPixOutputStride,\r\n    [inputHeight, inputWidth]: [number, number]): [number, number] {\r\n  const internalResolutionPercentage =\r\n      toInternalResolutionPercentage(internalResolution);\r\n\r\n  return [\r\n    toValidInputResolution(\r\n        inputHeight * internalResolutionPercentage, outputStride),\r\n    toValidInputResolution(\r\n        inputWidth * internalResolutionPercentage, outputStride)\r\n  ];\r\n}\r\n\r\nexport function toInputTensor(input: BodyPixInput) {\r\n  return input instanceof tf.Tensor ? input : tf.browser.fromPixels(input);\r\n}\r\n\r\nexport function resizeAndPadTo(\r\n    imageTensor: tf.Tensor3D, [targetH, targetW]: [number, number],\r\n    flipHorizontal = false): {\r\n  resizedAndPadded: tf.Tensor3D,\r\n  paddedBy: [[number, number], [number, number]]\r\n} {\r\n  const [height, width] = imageTensor.shape;\r\n\r\n  const targetAspect = targetW / targetH;\r\n  const aspect = width / height;\r\n\r\n  let resizeW: number;\r\n  let resizeH: number;\r\n  let padL: number;\r\n  let padR: number;\r\n  let padT: number;\r\n  let padB: number;\r\n\r\n  if (aspect > targetAspect) {\r\n    // resize to have the larger dimension match the shape.\r\n    resizeW = targetW;\r\n    resizeH = Math.ceil(resizeW / aspect);\r\n\r\n    const padHeight = targetH - resizeH;\r\n    padL = 0;\r\n    padR = 0;\r\n    padT = Math.floor(padHeight / 2);\r\n    padB = targetH - (resizeH + padT);\r\n  } else {\r\n    resizeH = targetH;\r\n    resizeW = Math.ceil(targetH * aspect);\r\n\r\n    const padWidth = targetW - resizeW;\r\n    padL = Math.floor(padWidth / 2);\r\n    padR = targetW - (resizeW + padL);\r\n    padT = 0;\r\n    padB = 0;\r\n  }\r\n\r\n  const resizedAndPadded = tf.tidy(() => {\r\n    // resize to have largest dimension match image\r\n    let resized: tf.Tensor3D;\r\n    if (flipHorizontal) {\r\n      resized = imageTensor.reverse(1).resizeBilinear([resizeH, resizeW]);\r\n    } else {\r\n      resized = imageTensor.resizeBilinear([resizeH, resizeW]);\r\n    }\r\n\r\n    const padded = tf.pad3d(resized, [[padT, padB], [padL, padR], [0, 0]]);\r\n\r\n    return padded;\r\n  });\r\n\r\n  return {resizedAndPadded, paddedBy: [[padT, padB], [padL, padR]]};\r\n}\r\n\r\nexport function scaleAndCropToInputTensorShape(\r\n    tensor: tf.Tensor3D,\r\n    [inputTensorHeight, inputTensorWidth]: [number, number],\r\n    [resizedAndPaddedHeight, resizedAndPaddedWidth]: [number, number],\r\n    [[padT, padB], [padL, padR]]: [[number, number], [number, number]],\r\n    applySigmoidActivation = false): tf.Tensor3D {\r\n  return tf.tidy(() => {\r\n    let inResizedAndPadded: tf.Tensor3D = tensor.resizeBilinear(\r\n        [resizedAndPaddedHeight, resizedAndPaddedWidth], true);\r\n\r\n    if (applySigmoidActivation) {\r\n      inResizedAndPadded = inResizedAndPadded.sigmoid();\r\n    }\r\n\r\n    return removePaddingAndResizeBack(\r\n        inResizedAndPadded, [inputTensorHeight, inputTensorWidth],\r\n        [[padT, padB], [padL, padR]]);\r\n  });\r\n}\r\n\r\nexport function removePaddingAndResizeBack(\r\n    resizedAndPadded: tf.Tensor3D,\r\n    [originalHeight, originalWidth]: [number, number],\r\n    [[padT, padB], [padL, padR]]: [[number, number], [number, number]]):\r\n    tf.Tensor3D {\r\n  return tf.tidy(() => {\r\n    const batchedImage: tf.Tensor4D = resizedAndPadded.expandDims();\r\n    return tf.image\r\n        .cropAndResize(\r\n            batchedImage, [[\r\n              padT / (originalHeight + padT + padB - 1.0),\r\n              padL / (originalWidth + padL + padR - 1.0),\r\n              (padT + originalHeight - 1.0) /\r\n                  (originalHeight + padT + padB - 1.0),\r\n              (padL + originalWidth - 1.0) / (originalWidth + padL + padR - 1.0)\r\n            ]],\r\n            [0], [originalHeight, originalWidth])\r\n        .squeeze([0]);\r\n  });\r\n}\r\n\r\nexport function resize2d(\r\n    tensor: tf.Tensor2D, resolution: [number, number],\r\n    nearestNeighbor?: boolean): tf.Tensor2D {\r\n  return tf.tidy(() => {\r\n    const batchedImage: tf.Tensor4D = tensor.expandDims(2);\r\n    return batchedImage.resizeBilinear(resolution, nearestNeighbor).squeeze();\r\n  });\r\n}\r\n\r\nexport function padAndResizeTo(\r\n    input: BodyPixInput, [targetH, targetW]: [number, number]):\r\n    {resized: tf.Tensor3D, padding: Padding} {\r\n  const [height, width] = getInputSize(input);\r\n  const targetAspect = targetW / targetH;\r\n  const aspect = width / height;\r\n  let [padT, padB, padL, padR] = [0, 0, 0, 0];\r\n  if (aspect < targetAspect) {\r\n    // pads the width\r\n    padT = 0;\r\n    padB = 0;\r\n    padL = Math.round(0.5 * (targetAspect * height - width));\r\n    padR = Math.round(0.5 * (targetAspect * height - width));\r\n  } else {\r\n    // pads the height\r\n    padT = Math.round(0.5 * ((1.0 / targetAspect) * width - height));\r\n    padB = Math.round(0.5 * ((1.0 / targetAspect) * width - height));\r\n    padL = 0;\r\n    padR = 0;\r\n  }\r\n\r\n  const resized: tf.Tensor3D = tf.tidy(() => {\r\n    let imageTensor = toInputTensor(input);\r\n    imageTensor = tf.pad3d(imageTensor, [[padT, padB], [padL, padR], [0, 0]]);\r\n\r\n    return imageTensor.resizeBilinear([targetH, targetW]);\r\n  });\r\n\r\n  return {resized, padding: {top: padT, left: padL, right: padR, bottom: padB}};\r\n}\r\n\r\nexport async function toTensorBuffers3D(tensors: tf.Tensor3D[]):\r\n    Promise<TensorBuffer3D[]> {\r\n  return Promise.all(tensors.map(tensor => tensor.buffer()));\r\n}\r\n\r\nexport function scalePose(\r\n    pose: Pose, scaleY: number, scaleX: number, offsetY = 0,\r\n    offsetX = 0): Pose {\r\n  return {\r\n    score: pose.score,\r\n    keypoints: pose.keypoints.map(({score, part, position}) => ({\r\n                                    score,\r\n                                    part,\r\n                                    position: {\r\n                                      x: position.x * scaleX + offsetX,\r\n                                      y: position.y * scaleY + offsetY\r\n                                    }\r\n                                  }))\r\n  };\r\n}\r\n\r\nexport function scalePoses(\r\n    poses: Pose[], scaleY: number, scaleX: number, offsetY = 0, offsetX = 0) {\r\n  if (scaleX === 1 && scaleY === 1 && offsetY === 0 && offsetX === 0) {\r\n    return poses;\r\n  }\r\n  return poses.map(pose => scalePose(pose, scaleY, scaleX, offsetY, offsetX));\r\n}\r\n\r\nexport function flipPoseHorizontal(pose: Pose, imageWidth: number): Pose {\r\n  return {\r\n    score: pose.score,\r\n    keypoints: pose.keypoints.map(\r\n        ({score, part, position}) => ({\r\n          score,\r\n          part,\r\n          position: {x: imageWidth - 1 - position.x, y: position.y}\r\n        }))\r\n  };\r\n}\r\n\r\nexport function flipPosesHorizontal(poses: Pose[], imageWidth: number) {\r\n  if (imageWidth <= 0) {\r\n    return poses;\r\n  }\r\n  return poses.map(pose => flipPoseHorizontal(pose, imageWidth));\r\n}\r\n\r\nexport function scaleAndFlipPoses(\r\n    poses: Pose[], [height, width]: [number, number],\r\n    [inputResolutionHeight, inputResolutionWidth]: [number, number],\r\n    padding: Padding, flipHorizontal: boolean): Pose[] {\r\n  const scaleY =\r\n      (height + padding.top + padding.bottom) / (inputResolutionHeight);\r\n  const scaleX =\r\n      (width + padding.left + padding.right) / (inputResolutionWidth);\r\n\r\n  const scaledPoses =\r\n      scalePoses(poses, scaleY, scaleX, -padding.top, -padding.left);\r\n\r\n  if (flipHorizontal) {\r\n    return flipPosesHorizontal(scaledPoses, width);\r\n  } else {\r\n    return scaledPoses;\r\n  }\r\n}\r\n","\r\n/**\r\n * @license\r\n * Copyright 2019 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport * as tfconv from '@tensorflow/tfjs-converter';\r\nimport * as tf from '@tensorflow/tfjs-core';\r\n\r\nimport {BaseModel} from './base_model';\r\nimport {decodeOnlyPartSegmentation, decodePartSegmentation, toMaskTensor} from './decode_part_map';\r\nimport {MobileNet} from './mobilenet';\r\nimport {decodePersonInstanceMasks, decodePersonInstancePartMasks} from './multi_person/decode_instance_masks';\r\nimport {decodeMultiplePoses} from './multi_person/decode_multiple_poses';\r\nimport {ResNet} from './resnet';\r\nimport {mobileNetSavedModel, resNet50SavedModel} from './saved_models';\r\nimport {BodyPixArchitecture, BodyPixInput, BodyPixInternalResolution, BodyPixMultiplier, BodyPixOutputStride, BodyPixQuantBytes, Padding} from './types';\r\nimport {PartSegmentation, PersonSegmentation, SemanticPartSegmentation, ExtendedSemanticPersonSegmentation} from './types';\r\nimport {getInputSize, padAndResizeTo, scaleAndCropToInputTensorShape, scaleAndFlipPoses, toInputResolutionHeightAndWidth, toTensorBuffers3D} from './util';\r\n\r\nconst APPLY_SIGMOID_ACTIVATION = true;\r\nconst FLIP_POSES_AFTER_SCALING = false;\r\n\r\n/**\r\n * BodyPix model loading is configurable using the following config dictionary.\r\n *\r\n * `architecture`: BodyPixArchitecture. It determines which BodyPix architecture\r\n * to load. The supported architectures are: MobileNetV1 and ResNet50.\r\n *\r\n * `outputStride`: Specifies the output stride of the BodyPix model.\r\n * The smaller the value, the larger the output resolution, and more accurate\r\n * the model at the cost of speed. Set this to a larger value to increase speed\r\n * at the cost of accuracy. Stride 32 is supported for ResNet and\r\n * stride 8,16,32 are supported for various MobileNetV1 models.\r\n *\r\n * `multiplier`: An optional number with values: 1.01, 1.0, 0.75, or\r\n * 0.50. The value is used only by MobileNet architecture. It is the float\r\n * multiplier for the depth (number of channels) for all convolution ops.\r\n * The larger the value, the larger the size of the layers, and more accurate\r\n * the model at the cost of speed. Set this to a smaller value to increase speed\r\n * at the cost of accuracy.\r\n *\r\n * `modelUrl`: An optional string that specifies custom url of the model. This\r\n * is useful for area/countries that don't have access to the model hosted on\r\n * GCP.\r\n *\r\n * `quantBytes`: An optional number with values: 1, 2, or 4.  This parameter\r\n * affects weight quantization in the models. The available options are\r\n * 1 byte, 2 bytes, and 4 bytes. The higher the value, the larger the model size\r\n * and thus the longer the loading time, the lower the value, the shorter the\r\n * loading time but lower the accuracy.\r\n */\r\nexport interface ModelConfig {\r\n  architecture: BodyPixArchitecture;\r\n  outputStride: BodyPixOutputStride;\r\n  multiplier?: BodyPixMultiplier;\r\n  modelUrl?: string;\r\n  quantBytes?: BodyPixQuantBytes;\r\n}\r\n\r\n// The default configuration for loading MobileNetV1 based BodyPix.\r\n//\r\n// (And for references, the default configuration for loading ResNet\r\n// based PoseNet is also included).\r\n//\r\n// ```\r\n// const RESNET_CONFIG = {\r\n//   architecture: 'ResNet50',\r\n//   outputStride: 32,\r\n//   quantBytes: 4,\r\n// } as ModelConfig;\r\n// ```\r\n\r\nconst MOBILENET_V1_CONFIG = {\r\n  architecture: 'MobileNetV1',\r\n  outputStride: 16,\r\n  quantBytes: 4,\r\n  multiplier: 0.75,\r\n} as ModelConfig;\r\n\r\nconst VALID_ARCHITECTURE: BodyPixArchitecture[] = ['MobileNetV1', 'ResNet50'];\r\nconst VALID_STRIDE: {[id: string]: BodyPixOutputStride[]} = {\r\n  'MobileNetV1': [8, 16, 32],\r\n  'ResNet50': [32, 16]\r\n};\r\nconst VALID_MULTIPLIER: {[id: string]: BodyPixMultiplier[]} = {\r\n  'MobileNetV1': [0.50, 0.75, 1.0],\r\n  'ResNet50': [1.0]\r\n};\r\nconst VALID_QUANT_BYTES: BodyPixQuantBytes[] = [1, 2, 4];\r\n\r\nfunction validateModelConfig(config: ModelConfig): ModelConfig {\r\n  config = config || MOBILENET_V1_CONFIG;\r\n\r\n  if (config.architecture == null) {\r\n    config.architecture = 'MobileNetV1';\r\n  }\r\n  if (VALID_ARCHITECTURE.indexOf(config.architecture) < 0) {\r\n    throw new Error(\r\n        `Invalid architecture ${config.architecture}. ` +\r\n        `Should be one of ${VALID_ARCHITECTURE}`);\r\n  }\r\n  if (config.outputStride == null) {\r\n    config.outputStride = 16;\r\n  }\r\n  if (VALID_STRIDE[config.architecture].indexOf(config.outputStride) < 0) {\r\n    throw new Error(\r\n        `Invalid outputStride ${config.outputStride}. ` +\r\n        `Should be one of ${VALID_STRIDE[config.architecture]} ` +\r\n        `for architecture ${config.architecture}.`);\r\n  }\r\n\r\n  if (config.multiplier == null) {\r\n    config.multiplier = 1.0;\r\n  }\r\n  if (VALID_MULTIPLIER[config.architecture].indexOf(config.multiplier) < 0) {\r\n    throw new Error(\r\n        `Invalid multiplier ${config.multiplier}. ` +\r\n        `Should be one of ${VALID_MULTIPLIER[config.architecture]} ` +\r\n        `for architecture ${config.architecture}.`);\r\n  }\r\n\r\n  if (config.quantBytes == null) {\r\n    config.quantBytes = 4;\r\n  }\r\n  if (VALID_QUANT_BYTES.indexOf(config.quantBytes) < 0) {\r\n    throw new Error(\r\n        `Invalid quantBytes ${config.quantBytes}. ` +\r\n        `Should be one of ${VALID_QUANT_BYTES} ` +\r\n        `for architecture ${config.architecture}.`);\r\n  }\r\n\r\n  return config;\r\n}\r\n\r\n/**\r\n * BodyPix inference is configurable using the following config dictionary.\r\n *\r\n * `flipHorizontal`: If the left-right keypoint of poses/part segmentation\r\n * should be flipped/mirrored horizontally. This should be set to true for\r\n * videos where the video is by default flipped horizontally (i.e. a webcam),\r\n * and you want the person & body part segmentation to be returned in the proper\r\n * orientation.\r\n *\r\n * `internalResolution`: Defaults to 'medium'. The internal resolution\r\n * percentage that the input is resized to before inference. The larger the\r\n * internalResolution the more accurate the model at the cost of slower\r\n * prediction times. Available values are 'low', 'medium', 'high', 'full', or a\r\n * percentage value between 0 and 1. The values 'low', 'medium', 'high', and\r\n * 'full' map to 0.25, 0.5, 0.75, and 1.0 correspondingly.\r\n *\r\n * `segmentationThreshold`: The minimum that segmentation values must\r\n * have to be considered part of the person. Affects the generation of the\r\n * segmentation mask. More specifically, it is the threshold used to binarize\r\n * the intermediate person segmentation probability. The probability of each\r\n * pixel belongs to a person is in range [0, 1]. If the probability is greater\r\n * than the `segmentationThreshold`, it will be set to 1 otherwise 0.\r\n *\r\n */\r\nexport interface InferenceConfig {\r\n  flipHorizontal?: boolean;\r\n  internalResolution?: BodyPixInternalResolution;\r\n  segmentationThreshold?: number;\r\n}\r\n\r\n/**\r\n * Person Inference Config\r\n *\r\n * `maxDetections`: Defaults to 10. Maximum number of person pose detections per\r\n * image.\r\n *\r\n * `scoreThreshold`: Defaults to 0.4. Only return person pose that have root\r\n * part score greater or equal to this value.\r\n *\r\n * `nmsRadius`: Defaults to 20. Non-maximum suppression part distance in pixels.\r\n * It needs to be strictly positive. Two pose keypoints suppress each other if\r\n * they are less than `nmsRadius` pixels away.\r\n */\r\nexport interface PersonInferenceConfig extends InferenceConfig {\r\n  maxDetections?: number;\r\n  scoreThreshold?: number;\r\n  nmsRadius?: number;\r\n}\r\n\r\n/**\r\n * Multiple Person Instance Inference Config\r\n *\r\n * `maxDetections`: Defaults to 10. Maximum number of returned instance\r\n * segmentation and pose detections per image.\r\n *\r\n * `scoreThreshold`: Defaults to 0.4. Only returns and uses person\r\n * poses for instance segmentation assignment when the pose has root part score\r\n * greater or equal to this value.\r\n *\r\n * `nmsRadius`: Defaults to 20. Non-maximum suppression part distance in pixels.\r\n * It needs to be strictly positive. Two parts suppress each other if they are\r\n * less than `nmsRadius` pixels away.\r\n *\r\n * `minKeypointScore`: Default to 0.3. Keypoints above the score are used\r\n * for matching and assigning segmentation mask to each person.\r\n *\r\n * `refineSteps`: Default to 10. The number of refinement steps used when\r\n * assigning the instance segmentation. It needs to be strictly positive. The\r\n * larger the higher the accuracy and slower the inference.\r\n *\r\n */\r\nexport interface MultiPersonInstanceInferenceConfig extends InferenceConfig {\r\n  maxDetections?: number;\r\n  scoreThreshold?: number;\r\n  nmsRadius?: number;\r\n  minKeypointScore?: number;\r\n  refineSteps?: number;\r\n}\r\n\r\nexport const PERSON_INFERENCE_CONFIG: PersonInferenceConfig = {\r\n  flipHorizontal: false,\r\n  internalResolution: 'medium',\r\n  segmentationThreshold: 0.7,\r\n  maxDetections: 10,\r\n  scoreThreshold: 0.4,\r\n  nmsRadius: 20,\r\n};\r\n\r\nexport const MULTI_PERSON_INSTANCE_INFERENCE_CONFIG:\r\n    MultiPersonInstanceInferenceConfig = {\r\n      flipHorizontal: false,\r\n      internalResolution: 'medium',\r\n      segmentationThreshold: 0.7,\r\n      maxDetections: 10,\r\n      scoreThreshold: 0.4,\r\n      nmsRadius: 20,\r\n      minKeypointScore: 0.3,\r\n      refineSteps: 10\r\n    };\r\n\r\nfunction validatePersonInferenceConfig(config: PersonInferenceConfig) {\r\n  const {segmentationThreshold, maxDetections, scoreThreshold, nmsRadius} =\r\n      config;\r\n\r\n  if (segmentationThreshold < 0.0 || segmentationThreshold > 1.0) {\r\n    throw new Error(\r\n        `segmentationThreshold ${segmentationThreshold}. ` +\r\n        `Should be in range [0.0, 1.0]`);\r\n  }\r\n\r\n  if (maxDetections <= 0) {\r\n    throw new Error(\r\n        `Invalid maxDetections ${maxDetections}. ` +\r\n        `Should be > 0`);\r\n  }\r\n\r\n  if (scoreThreshold < 0.0 || scoreThreshold > 1.0) {\r\n    throw new Error(\r\n        `Invalid scoreThreshold ${scoreThreshold}. ` +\r\n        `Should be in range [0.0, 1.0]`);\r\n  }\r\n\r\n  if (nmsRadius <= 0) {\r\n    throw new Error(`Invalid nmsRadius ${nmsRadius}.`);\r\n  }\r\n}\r\n\r\nfunction validateMultiPersonInstanceInferenceConfig(\r\n    config: MultiPersonInstanceInferenceConfig) {\r\n  const {\r\n    segmentationThreshold,\r\n    maxDetections,\r\n    scoreThreshold,\r\n    nmsRadius,\r\n    minKeypointScore,\r\n    refineSteps\r\n  } = config;\r\n\r\n  if (segmentationThreshold < 0.0 || segmentationThreshold > 1.0) {\r\n    throw new Error(\r\n        `segmentationThreshold ${segmentationThreshold}. ` +\r\n        `Should be in range [0.0, 1.0]`);\r\n  }\r\n\r\n  if (maxDetections <= 0) {\r\n    throw new Error(\r\n        `Invalid maxDetections ${maxDetections}. ` +\r\n        `Should be > 0`);\r\n  }\r\n\r\n  if (scoreThreshold < 0.0 || scoreThreshold > 1.0) {\r\n    throw new Error(\r\n        `Invalid scoreThreshold ${scoreThreshold}. ` +\r\n        `Should be in range [0.0, 1.0]`);\r\n  }\r\n\r\n  if (nmsRadius <= 0) {\r\n    throw new Error(`Invalid nmsRadius ${nmsRadius}.`);\r\n  }\r\n\r\n  if (minKeypointScore < 0 || minKeypointScore > 1) {\r\n    throw new Error(\r\n        `Invalid minKeypointScore ${minKeypointScore}.` +\r\n        `Should be in range [0.0, 1.0]`);\r\n  }\r\n\r\n  if (refineSteps <= 0 || refineSteps > 20) {\r\n    throw new Error(\r\n        `Invalid refineSteps ${refineSteps}.` +\r\n        `Should be in range [1, 20]`);\r\n  }\r\n}\r\n\r\nexport class BodyPix {\r\n  baseModel: BaseModel;\r\n\r\n  constructor(net: BaseModel) {\r\n    this.baseModel = net;\r\n  }\r\n\r\n  private predictForPersonSegmentation(input: tf.Tensor3D): {\r\n    segmentLogits: tf.Tensor3D,\r\n    heatmapScores: tf.Tensor3D,\r\n    offsets: tf.Tensor3D,\r\n    displacementFwd: tf.Tensor3D,\r\n    displacementBwd: tf.Tensor3D,\r\n  } {\r\n    const {\r\n      segmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n    } = this.baseModel.predict(input);\r\n    return {\r\n      segmentLogits: segmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n    };\r\n  }\r\n\r\n  private predictForPersonSegmentationAndPart(input: tf.Tensor3D): {\r\n    segmentLogits: tf.Tensor3D,\r\n    partHeatmapLogits: tf.Tensor3D,\r\n    heatmapScores: tf.Tensor3D,\r\n    offsets: tf.Tensor3D,\r\n    displacementFwd: tf.Tensor3D,\r\n    displacementBwd: tf.Tensor3D,\r\n  } {\r\n    const {\r\n      segmentation,\r\n      partHeatmaps,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd\r\n    } = this.baseModel.predict(input);\r\n    return {\r\n      segmentLogits: segmentation,\r\n      partHeatmapLogits: partHeatmaps,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n    };\r\n  }\r\n\r\n  private predictForMultiPersonInstanceSegmentationAndPart(input: tf.Tensor3D):\r\n      {\r\n        segmentLogits: tf.Tensor3D,\r\n        longOffsets: tf.Tensor3D,\r\n        heatmapScores: tf.Tensor3D,\r\n        offsets: tf.Tensor3D,\r\n        displacementFwd: tf.Tensor3D,\r\n        displacementBwd: tf.Tensor3D,\r\n        partHeatmaps: tf.Tensor3D\r\n      } {\r\n    const {\r\n      segmentation,\r\n      longOffsets,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      partHeatmaps,\r\n    } = this.baseModel.predict(input);\r\n    return {\r\n      segmentLogits: segmentation,\r\n      longOffsets,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      partHeatmaps\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Given an image with people, returns a dictionary of all intermediate\r\n   * tensors including: 1) a binary array with 1 for the pixels that are part of\r\n   * the person, and 0 otherwise, 2) heatmapScores, 3) offsets, and 4) paddings.\r\n   *\r\n   * @param input ImageData|HTMLImageElement|HTMLCanvasElement|HTMLVideoElement)\r\n   * The input image to feed through the network.\r\n   *\r\n   * @param internalResolution Defaults to 'medium'. The internal resolution\r\n   * that the input is resized to before inference. The larger the\r\n   * internalResolution the more accurate the model at the cost of slower\r\n   * prediction times. Available values are 'low', 'medium', 'high', 'full', or\r\n   * a percentage value between 0 and 1. The values 'low', 'medium', 'high', and\r\n   * 'full' map to 0.25, 0.5, 0.75, and 1.0 correspondingly.\r\n   *\r\n   * @param segmentationThreshold The minimum that segmentation values must have\r\n   * to be considered part of the person. Affects the generation of the\r\n   * segmentation mask.\r\n   *\r\n   * @return A dictionary containing `segmentation`, `heatmapScores`, `offsets`,\r\n   * and `padding`:\r\n   * - `segmentation`: A 2d Tensor with 1 for the pixels that are part of the\r\n   * person, and 0 otherwise. The width and height correspond to the same\r\n   * dimensions of the input image.\r\n   * - `heatmapScores`: A 3d Tensor of the keypoint heatmaps used by\r\n   * pose estimation decoding.\r\n   * - `offsets`: A 3d Tensor of the keypoint offsets used by pose\r\n   * estimation decoding.\r\n   * - `displacementFwd`: A 3d Tensor of the keypoint forward displacement used\r\n   * by pose estimation decoding.\r\n   * - `displacementBwd`: A 3d Tensor of the keypoint backward displacement used\r\n   * by pose estimation decoding.\r\n   * - `padding`: The padding (unit pixels) being applied to the input image\r\n   * before it is fed into the model.\r\n   */\r\n  segmentPersonActivation(\r\n      input: BodyPixInput, internalResolution: BodyPixInternalResolution,\r\n      segmentationThreshold = 0.5): {\r\n    segmentation: tf.Tensor2D,\r\n    segmentationScores: tf.Tensor2D,\r\n    heatmapScores: tf.Tensor3D,\r\n    offsets: tf.Tensor3D,\r\n    displacementFwd: tf.Tensor3D,\r\n    displacementBwd: tf.Tensor3D,\r\n    padding: Padding,\r\n    internalResolutionHeightAndWidth: [number, number]\r\n  } {\r\n    const [height, width] = getInputSize(input);\r\n    const internalResolutionHeightAndWidth = toInputResolutionHeightAndWidth(\r\n        internalResolution, this.baseModel.outputStride, [height, width]);\r\n    const {resized, padding} =\r\n        padAndResizeTo(input, internalResolutionHeightAndWidth);\r\n\r\n    const {\r\n      segmentationScores,\r\n      segmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd\r\n    } = tf.tidy(() => {\r\n      const {\r\n        segmentLogits,\r\n        heatmapScores,\r\n        offsets,\r\n        displacementFwd,\r\n        displacementBwd\r\n      } = this.predictForPersonSegmentation(resized);\r\n\r\n      const [resizedHeight, resizedWidth] = resized.shape;\r\n\r\n      const scaledSegmentScores = scaleAndCropToInputTensorShape(\r\n          segmentLogits, [height, width], [resizedHeight, resizedWidth],\r\n          [[padding.top, padding.bottom], [padding.left, padding.right]],\r\n          APPLY_SIGMOID_ACTIVATION);\r\n      const segmentationScores = scaledSegmentScores.squeeze() as tf.Tensor2D;\r\n      return {\r\n        segmentationScores,\r\n        segmentation:\r\n            toMaskTensor(segmentationScores, segmentationThreshold),\r\n        heatmapScores,\r\n        offsets,\r\n        displacementFwd,\r\n        displacementBwd,\r\n      };\r\n    });\r\n    resized.dispose();\r\n    return {\r\n      segmentationScores,\r\n      segmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      padding,\r\n      internalResolutionHeightAndWidth\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Given an image with many people, returns a PersonSegmentation dictionary\r\n   * that contains the segmentation mask for all people and a single pose.\r\n   *\r\n   * Note: The segmentation mask returned by this method covers all people but\r\n   * the pose works well for one person. If you want to estimate instance-level\r\n   * multiple person segmentation & pose for each person, use\r\n   * `segmentMultiPerson` instead.\r\n   *\r\n   * @param input ImageData|HTMLImageElement|HTMLCanvasElement|HTMLVideoElement)\r\n   * The input image to feed through the network.\r\n   *\r\n   * @param config PersonInferenceConfig object that contains\r\n   * parameters for the BodyPix inference using person decoding.\r\n   *\r\n   * @return A SemanticPersonSegmentation dictionary that contains height,\r\n   * width, the flattened binary segmentation mask and the poses for all people.\r\n   * The width and height correspond to the same dimensions of the input image.\r\n   * - `height`: The height of the segmentation data in pixel unit.\r\n   * - `width`: The width of the segmentation data in pixel unit.\r\n   * - `data`: The flattened Uint8Array of segmentation data. 1 means the pixel\r\n   * belongs to a person and 0 means the pixel doesn't belong to a person. The\r\n   * size of the array is equal to `height` x `width` in row-major order.\r\n   * - `allPoses`: The 2d poses of all people.\r\n   */\r\n  async segmentPerson(\r\n      input: BodyPixInput,\r\n      config: PersonInferenceConfig = PERSON_INFERENCE_CONFIG):\r\n      Promise<ExtendedSemanticPersonSegmentation> {\r\n    config = {...PERSON_INFERENCE_CONFIG, ...config};\r\n\r\n    validatePersonInferenceConfig(config);\r\n\r\n    const {\r\n      segmentationScores,\r\n      segmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      padding,\r\n      internalResolutionHeightAndWidth\r\n    } =\r\n        this.segmentPersonActivation(\r\n            input, config.internalResolution, config.segmentationThreshold);\r\n\r\n    const [height, width] = segmentation.shape;\r\n\r\n    const result = await segmentation.data() as Uint8Array;\r\n    segmentation.dispose();\r\n    const scores = await segmentationScores.data() as Float32Array;\r\n    segmentationScores.dispose();\r\n\r\n    const tensorBuffers = await toTensorBuffers3D(\r\n        [heatmapScores, offsets, displacementFwd, displacementBwd]);\r\n    const [scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf] =\r\n        tensorBuffers;\r\n\r\n    let poses = decodeMultiplePoses(\r\n        scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf,\r\n        this.baseModel.outputStride, config.maxDetections,\r\n        config.scoreThreshold, config.nmsRadius);\r\n\r\n    poses = scaleAndFlipPoses(\r\n        poses, [height, width], internalResolutionHeightAndWidth, padding,\r\n        FLIP_POSES_AFTER_SCALING);\r\n\r\n    heatmapScores.dispose();\r\n    offsets.dispose();\r\n    displacementFwd.dispose();\r\n    displacementBwd.dispose();\r\n\r\n    return {height, width, data: result, scores, allPoses: poses};\r\n  }\r\n\r\n  /**\r\n   * Given an image with multiple people, returns an *array* of\r\n   * PersonSegmentation object. Each element in the array corresponding to one\r\n   * of the people in the input image. In other words, it predicts\r\n   * instance-level multiple person segmentation & pose for each person.\r\n   *\r\n   * The model does standard ImageNet pre-processing before inferring through\r\n   * the model. The image pixels should have values [0-255].\r\n   *\r\n   * @param input\r\n   * ImageData|HTMLImageElement|HTMLCanvasElement|HTMLVideoElement) The input\r\n   * image to feed through the network.\r\n   *\r\n   * @param config MultiPersonInferenceConfig object that contains\r\n   * parameters for the BodyPix inference using multi-person decoding.\r\n   *\r\n   * @return An array of PersonSegmentation object, each containing a width,\r\n   * height, a binary array (1 for the pixels that are part of the\r\n   * person, and 0 otherwise) and 2D pose. The array size corresponds to the\r\n   * number of pixels in the image. The width and height correspond to the\r\n   * dimensions of the image the binary array is shaped to, which are the same\r\n   * dimensions of the input image.\r\n   */\r\n  async segmentMultiPerson(\r\n      input: BodyPixInput,\r\n      config: MultiPersonInstanceInferenceConfig =\r\n          MULTI_PERSON_INSTANCE_INFERENCE_CONFIG):\r\n      Promise<PersonSegmentation[]> {\r\n    config = {...MULTI_PERSON_INSTANCE_INFERENCE_CONFIG, ...config};\r\n    validateMultiPersonInstanceInferenceConfig(config);\r\n    const [height, width] = getInputSize(input);\r\n    const internalResolutionHeightAndWidth = toInputResolutionHeightAndWidth(\r\n        config.internalResolution, this.baseModel.outputStride,\r\n        [height, width]);\r\n\r\n    const {resized, padding} =\r\n        padAndResizeTo(input, internalResolutionHeightAndWidth);\r\n    const {\r\n      segmentation,\r\n      longOffsets,\r\n      heatmapScoresRaw,\r\n      offsetsRaw,\r\n      displacementFwdRaw,\r\n      displacementBwdRaw,\r\n    } = tf.tidy(() => {\r\n      const {\r\n        segmentLogits,\r\n        longOffsets,\r\n        heatmapScores,\r\n        offsets,\r\n        displacementFwd,\r\n        displacementBwd,\r\n      } = this.predictForMultiPersonInstanceSegmentationAndPart(resized);\r\n      const scaledSegmentScores = scaleAndCropToInputTensorShape(\r\n          segmentLogits, [height, width], internalResolutionHeightAndWidth,\r\n          [[padding.top, padding.bottom], [padding.left, padding.right]],\r\n          APPLY_SIGMOID_ACTIVATION);\r\n      const longOffsetsResized = false;\r\n      let scaledLongOffsets;\r\n      if (longOffsetsResized) {\r\n        scaledLongOffsets = scaleAndCropToInputTensorShape(\r\n            longOffsets, [height, width], internalResolutionHeightAndWidth,\r\n            [[padding.top, padding.bottom], [padding.left, padding.right]],\r\n            APPLY_SIGMOID_ACTIVATION);\r\n      } else {\r\n        scaledLongOffsets = longOffsets;\r\n      }\r\n\r\n      const segmentation = toMaskTensor(\r\n          scaledSegmentScores.squeeze(), config.segmentationThreshold);\r\n\r\n      return {\r\n        segmentation,\r\n        longOffsets: scaledLongOffsets,\r\n        heatmapScoresRaw: heatmapScores,\r\n        offsetsRaw: offsets,\r\n        displacementFwdRaw: displacementFwd,\r\n        displacementBwdRaw: displacementBwd,\r\n      };\r\n    });\r\n\r\n    const tensorBuffers = await toTensorBuffers3D(\r\n        [heatmapScoresRaw, offsetsRaw, displacementFwdRaw, displacementBwdRaw]);\r\n    const [scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf] =\r\n        tensorBuffers;\r\n\r\n    let poses = decodeMultiplePoses(\r\n        scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf,\r\n        this.baseModel.outputStride, config.maxDetections,\r\n        config.scoreThreshold, config.nmsRadius);\r\n\r\n    poses = scaleAndFlipPoses(\r\n        poses, [height, width], internalResolutionHeightAndWidth, padding,\r\n        FLIP_POSES_AFTER_SCALING);\r\n\r\n    const instanceMasks = await decodePersonInstanceMasks(\r\n        segmentation, longOffsets, poses, height, width,\r\n        this.baseModel.outputStride, internalResolutionHeightAndWidth, padding,\r\n        config.scoreThreshold, config.refineSteps, config.minKeypointScore,\r\n        config.maxDetections);\r\n\r\n    resized.dispose();\r\n    segmentation.dispose();\r\n    longOffsets.dispose();\r\n    heatmapScoresRaw.dispose();\r\n    offsetsRaw.dispose();\r\n    displacementFwdRaw.dispose();\r\n    displacementBwdRaw.dispose();\r\n\r\n    return instanceMasks;\r\n  }\r\n\r\n  /**\r\n   * Given an image with many people, returns a dictionary containing: height,\r\n   * width, a tensor with a part id from 0-24 for the pixels that are\r\n   * part of a corresponding body part, and -1 otherwise. This does standard\r\n   * ImageNet pre-processing before inferring through the model.  The image\r\n   * should pixels should have values [0-255].\r\n   *\r\n   * @param input ImageData|HTMLImageElement|HTMLCanvasElement|HTMLVideoElement)\r\n   * The input image to feed through the network.\r\n   *\r\n   * @param internalResolution Defaults to 'medium'. The internal resolution\r\n   * percentage that the input is resized to before inference. The larger the\r\n   * internalResolution the more accurate the model at the cost of slower\r\n   * prediction times. Available values are 'low', 'medium', 'high', 'full', or\r\n   * a percentage value between 0 and 1. The values 'low', 'medium', 'high', and\r\n   * 'full' map to 0.25, 0.5, 0.75, and 1.0 correspondingly.\r\n   *\r\n   * @param segmentationThreshold The minimum that segmentation values must have\r\n   * to be considered part of the person.  Affects the clipping of the colored\r\n   * part image.\r\n   *\r\n   * @return  A dictionary containing `partSegmentation`, `heatmapScores`,\r\n   * `offsets`, and `padding`:\r\n   * - `partSegmentation`: A 2d Tensor with a part id from 0-24 for\r\n   * the pixels that are part of a corresponding body part, and -1 otherwise.\r\n   * - `heatmapScores`: A 3d Tensor of the keypoint heatmaps used by\r\n   * single-person pose estimation decoding.\r\n   * - `offsets`: A 3d Tensor of the keypoint offsets used by single-person pose\r\n   * estimation decoding.\r\n   * - `displacementFwd`: A 3d Tensor of the keypoint forward displacement\r\n   * used by pose estimation decoding.\r\n   * - `displacementBwd`: A 3d Tensor of the keypoint backward displacement used\r\n   * by pose estimation decoding.\r\n   * - `padding`: The padding (unit pixels) being applied to the input image\r\n   * before it is fed into the model.\r\n   */\r\n  segmentPersonPartsActivation(\r\n      input: BodyPixInput, internalResolution: BodyPixInternalResolution,\r\n      segmentationThreshold = 0.5): {\r\n    partSegmentation: tf.Tensor2D,\r\n    heatmapScores: tf.Tensor3D,\r\n    offsets: tf.Tensor3D,\r\n    displacementFwd: tf.Tensor3D,\r\n    displacementBwd: tf.Tensor3D,\r\n    padding: Padding,\r\n    internalResolutionHeightAndWidth: [number, number]\r\n  } {\r\n    const [height, width] = getInputSize(input);\r\n    const internalResolutionHeightAndWidth = toInputResolutionHeightAndWidth(\r\n        internalResolution, this.baseModel.outputStride, [height, width]);\r\n    const {\r\n      resized,\r\n      padding,\r\n    } = padAndResizeTo(input, internalResolutionHeightAndWidth);\r\n\r\n    const {\r\n      partSegmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd\r\n    } = tf.tidy(() => {\r\n      const {\r\n        segmentLogits,\r\n        partHeatmapLogits,\r\n        heatmapScores,\r\n        offsets,\r\n        displacementFwd,\r\n        displacementBwd\r\n      } = this.predictForPersonSegmentationAndPart(resized);\r\n\r\n      const [resizedHeight, resizedWidth] = resized.shape;\r\n\r\n      const scaledSegmentScores = scaleAndCropToInputTensorShape(\r\n          segmentLogits, [height, width], [resizedHeight, resizedWidth],\r\n          [[padding.top, padding.bottom], [padding.left, padding.right]],\r\n          APPLY_SIGMOID_ACTIVATION);\r\n\r\n      const scaledPartHeatmapScore = scaleAndCropToInputTensorShape(\r\n          partHeatmapLogits, [height, width], [resizedHeight, resizedWidth],\r\n          [[padding.top, padding.bottom], [padding.left, padding.right]],\r\n          APPLY_SIGMOID_ACTIVATION);\r\n      const segmentation =\r\n          toMaskTensor(scaledSegmentScores.squeeze(), segmentationThreshold);\r\n      return {\r\n        partSegmentation:\r\n            decodePartSegmentation(segmentation, scaledPartHeatmapScore),\r\n        heatmapScores,\r\n        offsets,\r\n        displacementFwd,\r\n        displacementBwd,\r\n      };\r\n    });\r\n    resized.dispose();\r\n    return {\r\n      partSegmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      padding,\r\n      internalResolutionHeightAndWidth\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Given an image with many people, returns a PartSegmentation dictionary that\r\n   * contains the body part segmentation mask for all people and a single pose.\r\n   *\r\n   * Note: The body part segmentation mask returned by this method covers all\r\n   * people but the pose works well when there is one person. If you want to\r\n   * estimate instance-level multiple person body part segmentation & pose for\r\n   * each person, use `segmentMultiPersonParts` instead.\r\n   *\r\n   * @param input ImageData|HTMLImageElement|HTMLCanvasElement|HTMLVideoElement)\r\n   * The input image to feed through the network.\r\n   *\r\n   * @param config PersonInferenceConfig object that contains\r\n   * parameters for the BodyPix inference using single person decoding.\r\n   *\r\n   * @return A SemanticPartSegmentation dictionary that contains height, width,\r\n   * the flattened binary segmentation mask and the pose for the person. The\r\n   * width and height correspond to the same dimensions of the input image.\r\n   * - `height`: The height of the person part segmentation data in pixel unit.\r\n   * - `width`: The width of the person part segmentation data in pixel unit.\r\n   * - `data`: The flattened Int32Array of person part segmentation data with a\r\n   * part id from 0-24 for the pixels that are part of a corresponding body\r\n   * part, and -1 otherwise. The size of the array is equal to `height` x\r\n   * `width` in row-major order.\r\n   * - `allPoses`: The 2d poses of all people.\r\n   */\r\n  async segmentPersonParts(\r\n      input: BodyPixInput,\r\n      config: PersonInferenceConfig = PERSON_INFERENCE_CONFIG):\r\n      Promise<SemanticPartSegmentation> {\r\n    config = {...PERSON_INFERENCE_CONFIG, ...config};\r\n\r\n    validatePersonInferenceConfig(config);\r\n    const {\r\n      partSegmentation,\r\n      heatmapScores,\r\n      offsets,\r\n      displacementFwd,\r\n      displacementBwd,\r\n      padding,\r\n      internalResolutionHeightAndWidth\r\n    } =\r\n        this.segmentPersonPartsActivation(\r\n            input, config.internalResolution, config.segmentationThreshold);\r\n\r\n    const [height, width] = partSegmentation.shape;\r\n    const data = await partSegmentation.data() as Int32Array;\r\n    partSegmentation.dispose();\r\n\r\n    const tensorBuffers = await toTensorBuffers3D(\r\n        [heatmapScores, offsets, displacementFwd, displacementBwd]);\r\n    const [scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf] =\r\n        tensorBuffers;\r\n\r\n    let poses = decodeMultiplePoses(\r\n        scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf,\r\n        this.baseModel.outputStride, config.maxDetections,\r\n        config.scoreThreshold, config.nmsRadius);\r\n\r\n    poses = scaleAndFlipPoses(\r\n        poses, [height, width], internalResolutionHeightAndWidth, padding,\r\n        FLIP_POSES_AFTER_SCALING);\r\n\r\n    heatmapScores.dispose();\r\n    offsets.dispose();\r\n    displacementFwd.dispose();\r\n    displacementBwd.dispose();\r\n\r\n    return {height, width, data, allPoses: poses};\r\n  }\r\n\r\n  /**\r\n   * Given an image with multiple people, returns an *array* of PartSegmentation\r\n   * object. Each element in the array corresponding to one\r\n   * of the people in the input image. In other words, it predicts\r\n   * instance-level multiple person body part segmentation & pose for each\r\n   * person.\r\n   *\r\n   * This does standard ImageNet pre-processing before inferring through\r\n   * the model. The image pixels should have values [0-255].\r\n   *\r\n   * @param input\r\n   * ImageData|HTMLImageElement|HTMLCanvasElement|HTMLVideoElement) The input\r\n   * image to feed through the network.\r\n   *\r\n   * @param config MultiPersonInferenceConfig object that contains\r\n   * parameters for the BodyPix inference using multi-person decoding.\r\n   *\r\n   * @return An array of PartSegmentation object, each containing a width,\r\n   * height, a flattened array (with part id from 0-24 for the pixels that are\r\n   * part of a corresponding body part, and -1 otherwise) and 2D pose. The width\r\n   * and height correspond to the dimensions of the image. Each flattened part\r\n   * segmentation array size is equal to `height` x `width`.\r\n   */\r\n  async segmentMultiPersonParts(\r\n      input: BodyPixInput,\r\n      config: MultiPersonInstanceInferenceConfig =\r\n          MULTI_PERSON_INSTANCE_INFERENCE_CONFIG): Promise<PartSegmentation[]> {\r\n    config = {...MULTI_PERSON_INSTANCE_INFERENCE_CONFIG, ...config};\r\n\r\n    validateMultiPersonInstanceInferenceConfig(config);\r\n    const [height, width] = getInputSize(input);\r\n    const internalResolutionHeightAndWidth = toInputResolutionHeightAndWidth(\r\n        config.internalResolution, this.baseModel.outputStride,\r\n        [height, width]);\r\n    const {resized, padding} =\r\n        padAndResizeTo(input, internalResolutionHeightAndWidth);\r\n    const {\r\n      segmentation,\r\n      longOffsets,\r\n      heatmapScoresRaw,\r\n      offsetsRaw,\r\n      displacementFwdRaw,\r\n      displacementBwdRaw,\r\n      partSegmentation,\r\n    } = tf.tidy(() => {\r\n      const {\r\n        segmentLogits,\r\n        longOffsets,\r\n        heatmapScores,\r\n        offsets,\r\n        displacementFwd,\r\n        displacementBwd,\r\n        partHeatmaps\r\n      } = this.predictForMultiPersonInstanceSegmentationAndPart(resized);\r\n\r\n      // decoding with scaling.\r\n      const scaledSegmentScores = scaleAndCropToInputTensorShape(\r\n          segmentLogits, [height, width], internalResolutionHeightAndWidth,\r\n          [[padding.top, padding.bottom], [padding.left, padding.right]],\r\n          APPLY_SIGMOID_ACTIVATION);\r\n\r\n      // decoding with scaling.\r\n      const scaledPartSegmentationScores = scaleAndCropToInputTensorShape(\r\n          partHeatmaps, [height, width], internalResolutionHeightAndWidth,\r\n          [[padding.top, padding.bottom], [padding.left, padding.right]],\r\n          APPLY_SIGMOID_ACTIVATION);\r\n\r\n      const scaledLongOffsets = longOffsets;\r\n      const segmentation = toMaskTensor(\r\n          scaledSegmentScores.squeeze(), config.segmentationThreshold);\r\n      const partSegmentation =\r\n          decodeOnlyPartSegmentation(scaledPartSegmentationScores);\r\n      return {\r\n        segmentation,\r\n        longOffsets: scaledLongOffsets,\r\n        heatmapScoresRaw: heatmapScores,\r\n        offsetsRaw: offsets,\r\n        displacementFwdRaw: displacementFwd,\r\n        displacementBwdRaw: displacementBwd,\r\n        partSegmentation\r\n      };\r\n    });\r\n\r\n    const tensorBuffers = await toTensorBuffers3D(\r\n        [heatmapScoresRaw, offsetsRaw, displacementFwdRaw, displacementBwdRaw]);\r\n    const [scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf] =\r\n        tensorBuffers;\r\n\r\n    let poses = decodeMultiplePoses(\r\n        scoresBuf, offsetsBuf, displacementsFwdBuf, displacementsBwdBuf,\r\n        this.baseModel.outputStride, config.maxDetections,\r\n        config.scoreThreshold, config.nmsRadius);\r\n\r\n    poses = scaleAndFlipPoses(\r\n        poses, [height, width], internalResolutionHeightAndWidth, padding,\r\n        FLIP_POSES_AFTER_SCALING);\r\n\r\n    const instanceMasks = await decodePersonInstancePartMasks(\r\n        segmentation, longOffsets, partSegmentation, poses, height, width,\r\n        this.baseModel.outputStride, internalResolutionHeightAndWidth, padding,\r\n        config.scoreThreshold, config.refineSteps, config.minKeypointScore,\r\n        config.maxDetections);\r\n\r\n    resized.dispose();\r\n    segmentation.dispose();\r\n    longOffsets.dispose();\r\n    heatmapScoresRaw.dispose();\r\n    offsetsRaw.dispose();\r\n    displacementFwdRaw.dispose();\r\n    displacementBwdRaw.dispose();\r\n    partSegmentation.dispose();\r\n\r\n    return instanceMasks;\r\n  }\r\n\r\n  public dispose() {\r\n    this.baseModel.dispose();\r\n  }\r\n}\r\n\r\n/**\r\n * Loads the MobileNet BodyPix model.\r\n */\r\nasync function loadMobileNet(config: ModelConfig): Promise<BodyPix> {\r\n  const outputStride = config.outputStride;\r\n  const quantBytes = config.quantBytes;\r\n  const multiplier = config.multiplier;\r\n  if (tf == null) {\r\n    throw new Error(\r\n        `Cannot find TensorFlow.js. If you are using a <script> tag, please ` +\r\n        `also include @tensorflow/tfjs on the page before using this\r\n        model.`);\r\n  }\r\n\r\n  const url = mobileNetSavedModel(outputStride, multiplier, quantBytes);\r\n  const graphModel = await tfconv.loadGraphModel(config.modelUrl || url);\r\n  const mobilenet = new MobileNet(graphModel, outputStride);\r\n  return new BodyPix(mobilenet);\r\n}\r\n\r\n/**\r\n * Loads the ResNet BodyPix model.\r\n */\r\nasync function loadResNet(config: ModelConfig): Promise<BodyPix> {\r\n  const outputStride = config.outputStride;\r\n  const quantBytes = config.quantBytes;\r\n  if (tf == null) {\r\n    throw new Error(\r\n        `Cannot find TensorFlow.js. If you are using a <script> tag, please ` +\r\n        `also include @tensorflow/tfjs on the page before using this\r\n        model.`);\r\n  }\r\n\r\n  const url = resNet50SavedModel(outputStride, quantBytes);\r\n  const graphModel = await tfconv.loadGraphModel(config.modelUrl || url);\r\n  const resnet = new ResNet(graphModel, outputStride);\r\n  return new BodyPix(resnet);\r\n}\r\n\r\n/**\r\n * Loads the BodyPix model instance from a checkpoint, with the ResNet\r\n * or MobileNet architecture. The model to be loaded is configurable using the\r\n * config dictionary ModelConfig. Please find more details in the\r\n * documentation of the ModelConfig.\r\n *\r\n * @param config ModelConfig dictionary that contains parameters for\r\n * the BodyPix loading process. Please find more details of each parameters\r\n * in the documentation of the ModelConfig interface. The predefined\r\n * `MOBILENET_V1_CONFIG` and `RESNET_CONFIG` can also be used as references\r\n * for defining your customized config.\r\n */\r\nexport async function load(config: ModelConfig = MOBILENET_V1_CONFIG):\r\n    Promise<BodyPix> {\r\n  config = validateModelConfig(config);\r\n  if (config.architecture === 'ResNet50') {\r\n    return loadResNet(config);\r\n  } else if (config.architecture === 'MobileNetV1') {\r\n    return loadMobileNet(config);\r\n  } else {\r\n    return null;\r\n  }\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\n// method copied from bGlur in https://codepen.io/zhaojun/pen/zZmRQe\r\nexport function cpuBlur(\r\n    canvas: HTMLCanvasElement,\r\n    image: HTMLImageElement|HTMLVideoElement|HTMLCanvasElement, blur: number) {\r\n  const ctx = canvas.getContext('2d');\r\n\r\n  let sum = 0;\r\n  const delta = 5;\r\n  const alphaLeft = 1 / (2 * Math.PI * delta * delta);\r\n  const step = blur < 3 ? 1 : 2;\r\n  for (let y = -blur; y <= blur; y += step) {\r\n    for (let x = -blur; x <= blur; x += step) {\r\n      const weight =\r\n          alphaLeft * Math.exp(-(x * x + y * y) / (2 * delta * delta));\r\n      sum += weight;\r\n    }\r\n  }\r\n  for (let y = -blur; y <= blur; y += step) {\r\n    for (let x = -blur; x <= blur; x += step) {\r\n      ctx.globalAlpha = alphaLeft *\r\n          Math.exp(-(x * x + y * y) / (2 * delta * delta)) / sum * blur;\r\n      ctx.drawImage(image, x, y);\r\n    }\r\n  }\r\n  ctx.globalAlpha = 1;\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2019 Google LLC. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n * =============================================================================\r\n */\r\n\r\nimport {cpuBlur} from './blur';\r\nimport {Color, PartSegmentation, PersonSegmentation} from './types';\r\nimport {SemanticPartSegmentation, SemanticPersonSegmentation} from './types';\r\nimport {getInputSize} from './util';\r\n\r\nconst offScreenCanvases: {[name: string]: HTMLCanvasElement} = {};\r\n\r\ntype ImageType = HTMLImageElement|HTMLVideoElement|HTMLCanvasElement;\r\ntype HasDimensions = {\r\n  width: number,\r\n  height: number\r\n};\r\n\r\nfunction isSafari() {\r\n  return (/^((?!chrome|android).)*safari/i.test(navigator.userAgent));\r\n}\r\n\r\nfunction assertSameDimensions(\r\n    {width: widthA, height: heightA}: HasDimensions,\r\n    {width: widthB, height: heightB}: HasDimensions, nameA: string,\r\n    nameB: string) {\r\n  if (widthA !== widthB || heightA !== heightB) {\r\n    throw new Error(`error: dimensions must match. ${nameA} has dimensions ${\r\n        widthA}x${heightA}, ${nameB} has dimensions ${widthB}x${heightB}`);\r\n  }\r\n}\r\n\r\nfunction flipCanvasHorizontal(canvas: HTMLCanvasElement) {\r\n  const ctx = canvas.getContext('2d');\r\n  ctx.scale(-1, 1);\r\n  ctx.translate(-canvas.width, 0);\r\n}\r\n\r\nfunction drawWithCompositing(\r\n    ctx: CanvasRenderingContext2D, image: HTMLCanvasElement|ImageType,\r\n    compositOperation: string) {\r\n  ctx.globalCompositeOperation = compositOperation;\r\n  ctx.drawImage(image, 0, 0);\r\n}\r\n\r\nfunction createOffScreenCanvas(): HTMLCanvasElement {\r\n  const offScreenCanvas = document.createElement('canvas');\r\n  return offScreenCanvas;\r\n}\r\n\r\nfunction ensureOffscreenCanvasCreated(id: string): HTMLCanvasElement {\r\n  if (!offScreenCanvases[id]) {\r\n    offScreenCanvases[id] = createOffScreenCanvas();\r\n  }\r\n  return offScreenCanvases[id];\r\n}\r\n\r\nfunction drawAndBlurImageOnCanvas(\r\n    image: ImageType, blurAmount: number, canvas: HTMLCanvasElement) {\r\n  const {height, width} = image;\r\n  const ctx = canvas.getContext('2d');\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  ctx.clearRect(0, 0, width, height);\r\n  ctx.save();\r\n  if (isSafari()) {\r\n    cpuBlur(canvas, image, blurAmount);\r\n  } else {\r\n    // tslint:disable:no-any\r\n    (ctx as any).filter = `blur(${blurAmount}px)`;\r\n    ctx.drawImage(image, 0, 0, width, height);\r\n  }\r\n  ctx.restore();\r\n}\r\n\r\nfunction drawAndBlurImageOnOffScreenCanvas(\r\n    image: ImageType, blurAmount: number,\r\n    offscreenCanvasName: string): HTMLCanvasElement {\r\n  const canvas = ensureOffscreenCanvasCreated(offscreenCanvasName);\r\n  if (blurAmount === 0) {\r\n    renderImageToCanvas(image, canvas);\r\n  } else {\r\n    drawAndBlurImageOnCanvas(image, blurAmount, canvas);\r\n  }\r\n  return canvas;\r\n}\r\n\r\nfunction renderImageToCanvas(image: ImageType, canvas: HTMLCanvasElement) {\r\n  const {width, height} = image;\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  const ctx = canvas.getContext('2d');\r\n\r\n  ctx.drawImage(image, 0, 0, width, height);\r\n}\r\n/**\r\n * Draw an image on a canvas\r\n */\r\nfunction renderImageDataToCanvas(image: ImageData, canvas: HTMLCanvasElement) {\r\n  canvas.width = image.width;\r\n  canvas.height = image.height;\r\n  const ctx = canvas.getContext('2d');\r\n\r\n  ctx.putImageData(image, 0, 0);\r\n}\r\n\r\nfunction renderImageDataToOffScreenCanvas(\r\n    image: ImageData, canvasName: string): HTMLCanvasElement {\r\n  const canvas = ensureOffscreenCanvasCreated(canvasName);\r\n  renderImageDataToCanvas(image, canvas);\r\n\r\n  return canvas;\r\n}\r\n\r\n/**\r\n * Given the output from estimating multi-person segmentation, generates an\r\n * image with foreground and background color at each pixel determined by the\r\n * corresponding binary segmentation value at the pixel from the output.  In\r\n * other words, pixels where there is a person will be colored with foreground\r\n * color and where there is not a person will be colored with background color.\r\n *\r\n * @param personOrPartSegmentation The output from\r\n * `segmentPerson`, `segmentMultiPerson`,\r\n * `segmentPersonParts` or `segmentMultiPersonParts`. They can\r\n * be SemanticPersonSegmentation object, an array of PersonSegmentation object,\r\n * SemanticPartSegmentation object, or an array of PartSegmentation object.\r\n *\r\n * @param foreground Default to {r:0, g:0, b:0, a: 0}. The foreground color\r\n * (r,g,b,a) for visualizing pixels that belong to people.\r\n *\r\n * @param background Default to {r:0, g:0, b:0, a: 255}. The background color\r\n * (r,g,b,a) for visualizing pixels that don't belong to people.\r\n *\r\n * @param drawContour Default to false. Whether to draw the contour around each\r\n * person's segmentation mask or body part mask.\r\n *\r\n * @param foregroundIds Default to [1]. The integer values that represent\r\n * foreground. For person segmentation, 1 is the foreground. For body part\r\n * segmentation, it can be a subset of all body parts ids.\r\n *\r\n * @returns An ImageData with the same width and height of\r\n * all the PersonSegmentation in multiPersonSegmentation, with opacity and\r\n * transparency at each pixel determined by the corresponding binary\r\n * segmentation value at the pixel from the output.\r\n */\r\nexport function toMask(\r\n    personOrPartSegmentation: SemanticPersonSegmentation|\r\n    SemanticPartSegmentation|PersonSegmentation[]|PartSegmentation[],\r\n    foreground: Color = {\r\n      r: 0,\r\n      g: 0,\r\n      b: 0,\r\n      a: 0\r\n    },\r\n    background: Color = {\r\n      r: 0,\r\n      g: 0,\r\n      b: 0,\r\n      a: 255\r\n    },\r\n    drawContour = false, foregroundIds: number[] = [1]): ImageData {\r\n  if (Array.isArray(personOrPartSegmentation) &&\r\n      personOrPartSegmentation.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  let multiPersonOrPartSegmentation:\r\n      Array<SemanticPersonSegmentation|SemanticPartSegmentation|\r\n            PersonSegmentation|PartSegmentation>;\r\n\r\n  if (!Array.isArray(personOrPartSegmentation)) {\r\n    multiPersonOrPartSegmentation = [personOrPartSegmentation];\r\n  } else {\r\n    multiPersonOrPartSegmentation = personOrPartSegmentation;\r\n  }\r\n\r\n  const {width, height} = multiPersonOrPartSegmentation[0];\r\n  const bytes = new Uint8ClampedArray(width * height * 4);\r\n\r\n  function drawStroke(\r\n      bytes: Uint8ClampedArray, row: number, column: number, width: number,\r\n      radius: number, color: Color = {r: 0, g: 255, b: 255, a: 255}) {\r\n    for (let i = -radius; i <= radius; i++) {\r\n      for (let j = -radius; j <= radius; j++) {\r\n        if (i !== 0 && j !== 0) {\r\n          const n = (row + i) * width + (column + j);\r\n          bytes[4 * n + 0] = color.r;\r\n          bytes[4 * n + 1] = color.g;\r\n          bytes[4 * n + 2] = color.b;\r\n          bytes[4 * n + 3] = color.a;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  function isSegmentationBoundary(\r\n      segmentationData: Uint8Array|Int32Array,\r\n      row: number,\r\n      column: number,\r\n      width: number,\r\n      foregroundIds: number[] = [1],\r\n      radius = 1,\r\n      ): boolean {\r\n    let numberBackgroundPixels = 0;\r\n    for (let i = -radius; i <= radius; i++) {\r\n      for (let j = -radius; j <= radius; j++) {\r\n        if (i !== 0 && j !== 0) {\r\n          const n = (row + i) * width + (column + j);\r\n          if (!foregroundIds.some(id => id === segmentationData[n])) {\r\n            numberBackgroundPixels += 1;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return numberBackgroundPixels > 0;\r\n  }\r\n\r\n  for (let i = 0; i < height; i += 1) {\r\n    for (let j = 0; j < width; j += 1) {\r\n      const n = i * width + j;\r\n      bytes[4 * n + 0] = background.r;\r\n      bytes[4 * n + 1] = background.g;\r\n      bytes[4 * n + 2] = background.b;\r\n      bytes[4 * n + 3] = background.a;\r\n      for (let k = 0; k < multiPersonOrPartSegmentation.length; k++) {\r\n        if (foregroundIds.some(\r\n                id => id === multiPersonOrPartSegmentation[k].data[n])) {\r\n          bytes[4 * n] = foreground.r;\r\n          bytes[4 * n + 1] = foreground.g;\r\n          bytes[4 * n + 2] = foreground.b;\r\n          bytes[4 * n + 3] = foreground.a;\r\n          const isBoundary = isSegmentationBoundary(\r\n              multiPersonOrPartSegmentation[k].data, i, j, width,\r\n              foregroundIds);\r\n          if (drawContour && i - 1 >= 0 && i + 1 < height && j - 1 >= 0 &&\r\n              j + 1 < width && isBoundary) {\r\n            drawStroke(bytes, i, j, width, 1);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return new ImageData(bytes, width, height);\r\n}\r\n\r\nconst RAINBOW_PART_COLORS: Array<[number, number, number]> = [\r\n  [110, 64, 170], [143, 61, 178], [178, 60, 178], [210, 62, 167],\r\n  [238, 67, 149], [255, 78, 125], [255, 94, 99],  [255, 115, 75],\r\n  [255, 140, 56], [239, 167, 47], [217, 194, 49], [194, 219, 64],\r\n  [175, 240, 91], [135, 245, 87], [96, 247, 96],  [64, 243, 115],\r\n  [40, 234, 141], [28, 219, 169], [26, 199, 194], [33, 176, 213],\r\n  [47, 150, 224], [65, 125, 224], [84, 101, 214], [99, 81, 195]\r\n];\r\n\r\n/**\r\n * Given the output from person body part segmentation (or multi-person\r\n * instance body part segmentation) and an array of colors indexed by part id,\r\n * generates an image with the corresponding color for each part at each pixel,\r\n * and white pixels where there is no part.\r\n *\r\n * @param partSegmentation The output from segmentPersonParts\r\n * or segmentMultiPersonParts. The former is a SemanticPartSegmentation\r\n * object and later is an array of PartSegmentation object.\r\n *\r\n * @param partColors A multi-dimensional array of rgb colors indexed by\r\n * part id.  Must have 24 colors, one for every part.\r\n *\r\n * @returns An ImageData with the same width and height of all the element in\r\n * multiPersonPartSegmentation, with the corresponding color for each part at\r\n * each pixel, and black pixels where there is no part.\r\n */\r\nexport function toColoredPartMask(\r\n    partSegmentation: SemanticPartSegmentation|PartSegmentation[],\r\n    partColors: Array<[number, number, number]> =\r\n        RAINBOW_PART_COLORS): ImageData {\r\n  if (Array.isArray(partSegmentation) && partSegmentation.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  let multiPersonPartSegmentation;\r\n  if (!Array.isArray(partSegmentation)) {\r\n    multiPersonPartSegmentation = [partSegmentation];\r\n  } else {\r\n    multiPersonPartSegmentation = partSegmentation;\r\n  }\r\n  const {width, height} = multiPersonPartSegmentation[0];\r\n  const bytes = new Uint8ClampedArray(width * height * 4);\r\n\r\n  for (let i = 0; i < height * width; ++i) {\r\n    // invert mask.  Invert the segmentation mask.\r\n    const j = i * 4;\r\n    bytes[j + 0] = 255;\r\n    bytes[j + 1] = 255;\r\n    bytes[j + 2] = 255;\r\n    bytes[j + 3] = 255;\r\n    for (let k = 0; k < multiPersonPartSegmentation.length; k++) {\r\n      const partId = multiPersonPartSegmentation[k].data[i];\r\n      if (partId !== -1) {\r\n        const color = partColors[partId];\r\n        if (!color) {\r\n          throw new Error(`No color could be found for part id ${partId}`);\r\n        }\r\n        bytes[j + 0] = color[0];\r\n        bytes[j + 1] = color[1];\r\n        bytes[j + 2] = color[2];\r\n        bytes[j + 3] = 255;\r\n      }\r\n    }\r\n  }\r\n  return new ImageData(bytes, width, height);\r\n}\r\n\r\nconst CANVAS_NAMES = {\r\n  blurred: 'blurred',\r\n  blurredMask: 'blurred-mask',\r\n  mask: 'mask',\r\n  lowresPartMask: 'lowres-part-mask',\r\n};\r\n\r\n/**\r\n * Given an image and a maskImage of type ImageData, draws the image with the\r\n * mask on top of it onto a canvas.\r\n *\r\n * @param canvas The canvas to be drawn onto.\r\n *\r\n * @param image The original image to apply the mask to.\r\n *\r\n * @param maskImage An ImageData containing the mask.  Ideally this should be\r\n * generated by toMask or toColoredPartMask.\r\n *\r\n * @param maskOpacity The opacity of the mask when drawing it on top of the\r\n * image. Defaults to 0.7. Should be a float between 0 and 1.\r\n *\r\n * @param maskBlurAmount How many pixels to blur the mask by. Defaults to 0.\r\n * Should be an integer between 0 and 20.\r\n *\r\n * @param flipHorizontal If the result should be flipped horizontally.  Defaults\r\n * to false.\r\n */\r\nexport function drawMask(\r\n    canvas: HTMLCanvasElement, image: ImageType, maskImage: ImageData|null,\r\n    maskOpacity = 0.7, maskBlurAmount = 0, flipHorizontal = false) {\r\n  const [height, width] = getInputSize(image);\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n\r\n  const ctx = canvas.getContext('2d');\r\n  ctx.save();\r\n  if (flipHorizontal) {\r\n    flipCanvasHorizontal(canvas);\r\n  }\r\n\r\n  ctx.drawImage(image, 0, 0);\r\n\r\n  ctx.globalAlpha = maskOpacity;\r\n  if (maskImage) {\r\n    assertSameDimensions({width, height}, maskImage, 'image', 'mask');\r\n\r\n    const mask = renderImageDataToOffScreenCanvas(maskImage, CANVAS_NAMES.mask);\r\n\r\n    const blurredMask = drawAndBlurImageOnOffScreenCanvas(\r\n        mask, maskBlurAmount, CANVAS_NAMES.blurredMask);\r\n    ctx.drawImage(blurredMask, 0, 0, width, height);\r\n  }\r\n  ctx.restore();\r\n}\r\n\r\n/**\r\n * Given an image and a maskImage of type ImageData, draws the image with the\r\n * pixelated mask on top of it onto a canvas.\r\n *\r\n * @param canvas The canvas to be drawn onto.\r\n *\r\n * @param image The original image to apply the mask to.\r\n *\r\n * @param maskImage An ImageData containing the mask.  Ideally this should be\r\n * generated by toColoredPartMask.\r\n *\r\n * @param maskOpacity The opacity of the mask when drawing it on top of the\r\n * image. Defaults to 0.7. Should be a float between 0 and 1.\r\n *\r\n * @param maskBlurAmount How many pixels to blur the mask by. Defaults to 0.\r\n * Should be an integer between 0 and 20.\r\n *\r\n * @param flipHorizontal If the result should be flipped horizontally.  Defaults\r\n * to false.\r\n *\r\n * @param pixelCellWidth The width of each pixel cell. Default to 10 px.\r\n */\r\nexport function drawPixelatedMask(\r\n    canvas: HTMLCanvasElement, image: ImageType, maskImage: ImageData,\r\n    maskOpacity = 0.7, maskBlurAmount = 0, flipHorizontal = false,\r\n    pixelCellWidth = 10.0) {\r\n  const [height, width] = getInputSize(image);\r\n  assertSameDimensions({width, height}, maskImage, 'image', 'mask');\r\n\r\n  const mask = renderImageDataToOffScreenCanvas(maskImage, CANVAS_NAMES.mask);\r\n  const blurredMask = drawAndBlurImageOnOffScreenCanvas(\r\n      mask, maskBlurAmount, CANVAS_NAMES.blurredMask);\r\n\r\n  canvas.width = blurredMask.width;\r\n  canvas.height = blurredMask.height;\r\n\r\n  const ctx = canvas.getContext('2d');\r\n  ctx.save();\r\n  if (flipHorizontal) {\r\n    flipCanvasHorizontal(canvas);\r\n  }\r\n\r\n  const offscreenCanvas =\r\n      ensureOffscreenCanvasCreated(CANVAS_NAMES.lowresPartMask);\r\n  const offscreenCanvasCtx = offscreenCanvas.getContext('2d');\r\n  offscreenCanvas.width = blurredMask.width * (1.0 / pixelCellWidth);\r\n  offscreenCanvas.height = blurredMask.height * (1.0 / pixelCellWidth);\r\n  offscreenCanvasCtx.drawImage(\r\n      blurredMask, 0, 0, blurredMask.width, blurredMask.height, 0, 0,\r\n      offscreenCanvas.width, offscreenCanvas.height);\r\n  ctx.imageSmoothingEnabled = false;\r\n  ctx.drawImage(\r\n      offscreenCanvas, 0, 0, offscreenCanvas.width, offscreenCanvas.height, 0,\r\n      0, canvas.width, canvas.height);\r\n\r\n  // Draws vertical grid lines that are `pixelCellWidth` apart from each other.\r\n  for (let i = 0; i < offscreenCanvas.width; i++) {\r\n    ctx.beginPath();\r\n    ctx.strokeStyle = '#ffffff';\r\n    ctx.moveTo(pixelCellWidth * i, 0);\r\n    ctx.lineTo(pixelCellWidth * i, canvas.height);\r\n    ctx.stroke();\r\n  }\r\n\r\n  // Draws horizontal grid lines that are `pixelCellWidth` apart from each\r\n  // other.\r\n  for (let i = 0; i < offscreenCanvas.height; i++) {\r\n    ctx.beginPath();\r\n    ctx.strokeStyle = '#ffffff';\r\n    ctx.moveTo(0, pixelCellWidth * i);\r\n    ctx.lineTo(canvas.width, pixelCellWidth * i);\r\n    ctx.stroke();\r\n  }\r\n\r\n  ctx.globalAlpha = 1.0 - maskOpacity;\r\n  ctx.drawImage(image, 0, 0, blurredMask.width, blurredMask.height);\r\n  ctx.restore();\r\n}\r\n\r\nfunction createPersonMask(\r\n    multiPersonSegmentation: PersonSegmentation[]|SemanticPersonSegmentation,\r\n    edgeBlurAmount: number): HTMLCanvasElement {\r\n  const backgroundMaskImage = toMask(\r\n      multiPersonSegmentation, {r: 0, g: 0, b: 0, a: 255},\r\n      {r: 0, g: 0, b: 0, a: 0});\r\n\r\n  const backgroundMask =\r\n      renderImageDataToOffScreenCanvas(backgroundMaskImage, CANVAS_NAMES.mask);\r\n  if (edgeBlurAmount === 0) {\r\n    return backgroundMask;\r\n  } else {\r\n    return drawAndBlurImageOnOffScreenCanvas(\r\n        backgroundMask, edgeBlurAmount, CANVAS_NAMES.blurredMask);\r\n  }\r\n}\r\n\r\n/**\r\n * Given a personSegmentation and an image, draws the image with its background\r\n * blurred onto the canvas.\r\n *\r\n * @param canvas The canvas to draw the background-blurred image onto.\r\n *\r\n * @param image The image to blur the background of and draw.\r\n *\r\n * @param personSegmentation A SemanticPersonSegmentation or an array of\r\n * PersonSegmentation object.\r\n *\r\n * @param backgroundBlurAmount How many pixels in the background blend into each\r\n * other.  Defaults to 3. Should be an integer between 1 and 20.\r\n *\r\n * @param edgeBlurAmount How many pixels to blur on the edge between the person\r\n * and the background by.  Defaults to 3. Should be an integer between 0 and 20.\r\n *\r\n * @param flipHorizontal If the output should be flipped horizontally.  Defaults\r\n * to false.\r\n */\r\nexport function drawBokehEffect(\r\n    canvas: HTMLCanvasElement, image: ImageType,\r\n    multiPersonSegmentation: SemanticPersonSegmentation|PersonSegmentation[],\r\n    backgroundBlurAmount = 3, edgeBlurAmount = 3, flipHorizontal = false) {\r\n  const blurredImage = drawAndBlurImageOnOffScreenCanvas(\r\n      image, backgroundBlurAmount, CANVAS_NAMES.blurred);\r\n  canvas.width = blurredImage.width;\r\n  canvas.height = blurredImage.height;\r\n\r\n  const ctx = canvas.getContext('2d');\r\n\r\n  if (Array.isArray(multiPersonSegmentation) &&\r\n      multiPersonSegmentation.length === 0) {\r\n    ctx.drawImage(blurredImage, 0, 0);\r\n    return;\r\n  }\r\n\r\n  const personMask = createPersonMask(multiPersonSegmentation, edgeBlurAmount);\r\n\r\n  ctx.save();\r\n  if (flipHorizontal) {\r\n    flipCanvasHorizontal(canvas);\r\n  }\r\n  // draw the original image on the final canvas\r\n  const [height, width] = getInputSize(image);\r\n  ctx.drawImage(image, 0, 0, width, height);\r\n\r\n  // \"destination-in\" - \"The existing canvas content is kept where both the\r\n  // new shape and existing canvas content overlap. Everything else is made\r\n  // transparent.\"\r\n  // crop what's not the person using the mask from the original image\r\n  drawWithCompositing(ctx, personMask, 'destination-in');\r\n  // \"destination-over\" - \"The existing canvas content is kept where both the\r\n  // new shape and existing canvas content overlap. Everything else is made\r\n  // transparent.\"\r\n  // draw the blurred background on top of the original image where it doesn't\r\n  // overlap.\r\n  drawWithCompositing(ctx, blurredImage, 'destination-over');\r\n  ctx.restore();\r\n}\r\n\r\nfunction createBodyPartMask(\r\n    multiPersonPartSegmentation: SemanticPartSegmentation|PartSegmentation[],\r\n    bodyPartIdsToMask: number[], edgeBlurAmount: number): HTMLCanvasElement {\r\n  const backgroundMaskImage = toMask(\r\n      multiPersonPartSegmentation, {r: 0, g: 0, b: 0, a: 0},\r\n      {r: 0, g: 0, b: 0, a: 255}, true, bodyPartIdsToMask);\r\n\r\n  const backgroundMask =\r\n      renderImageDataToOffScreenCanvas(backgroundMaskImage, CANVAS_NAMES.mask);\r\n  if (edgeBlurAmount === 0) {\r\n    return backgroundMask;\r\n  } else {\r\n    return drawAndBlurImageOnOffScreenCanvas(\r\n        backgroundMask, edgeBlurAmount, CANVAS_NAMES.blurredMask);\r\n  }\r\n}\r\n\r\n/**\r\n * Given a personSegmentation and an image, draws the image with its background\r\n * blurred onto the canvas.\r\n *\r\n * @param canvas The canvas to draw the background-blurred image onto.\r\n *\r\n * @param image The image to blur the background of and draw.\r\n *\r\n * @param partSegmentation A SemanticPartSegmentation or an array of\r\n * PartSegmentation object.\r\n *\r\n * @param bodyPartIdsToBlur Default to [0, 1] (left-face and right-face). An\r\n * array of body part ids to blur. Each must be one of the 24 body part ids.\r\n *\r\n * @param backgroundBlurAmount How many pixels in the background blend into each\r\n * other.  Defaults to 3. Should be an integer between 1 and 20.\r\n *\r\n * @param edgeBlurAmount How many pixels to blur on the edge between the person\r\n * and the background by.  Defaults to 3. Should be an integer between 0 and 20.\r\n *\r\n * @param flipHorizontal If the output should be flipped horizontally.  Defaults\r\n * to false.\r\n */\r\nexport function blurBodyPart(\r\n    canvas: HTMLCanvasElement, image: ImageType,\r\n    partSegmentation: SemanticPartSegmentation|PartSegmentation[],\r\n    bodyPartIdsToBlur = [0, 1], backgroundBlurAmount = 3, edgeBlurAmount = 3,\r\n    flipHorizontal = false) {\r\n  const blurredImage = drawAndBlurImageOnOffScreenCanvas(\r\n      image, backgroundBlurAmount, CANVAS_NAMES.blurred);\r\n  canvas.width = blurredImage.width;\r\n  canvas.height = blurredImage.height;\r\n\r\n  const ctx = canvas.getContext('2d');\r\n\r\n  if (Array.isArray(partSegmentation) && partSegmentation.length === 0) {\r\n    ctx.drawImage(blurredImage, 0, 0);\r\n    return;\r\n  }\r\n  const bodyPartMask =\r\n      createBodyPartMask(partSegmentation, bodyPartIdsToBlur, edgeBlurAmount);\r\n\r\n  ctx.save();\r\n  if (flipHorizontal) {\r\n    flipCanvasHorizontal(canvas);\r\n  }\r\n  // draw the original image on the final canvas\r\n  const [height, width] = getInputSize(image);\r\n  ctx.drawImage(image, 0, 0, width, height);\r\n\r\n  // \"destination-in\" - \"The existing canvas content is kept where both the\r\n  // new shape and existing canvas content overlap. Everything else is made\r\n  // transparent.\"\r\n  // crop what's not the person using the mask from the original image\r\n  drawWithCompositing(ctx, bodyPartMask, 'destination-in');\r\n  // \"destination-over\" - \"The existing canvas content is kept where both the\r\n  // new shape and existing canvas content overlap. Everything else is made\r\n  // transparent.\"\r\n  // draw the blurred background on top of the original image where it doesn't\r\n  // overlap.\r\n  drawWithCompositing(ctx, blurredImage, 'destination-over');\r\n  ctx.restore();\r\n}\r\n","/**\r\n * @license\r\n * Copyright 2020 Google Inc. All Rights Reserved.\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n *\r\n * =============================================================================\r\n */\r\n\r\nexport const PART_CHANNELS: string[] = [\r\n  'left_face',\r\n  'right_face',\r\n  'left_upper_arm_front',\r\n  'left_upper_arm_back',\r\n  'right_upper_arm_front',\r\n  'right_upper_arm_back',\r\n  'left_lower_arm_front',\r\n  'left_lower_arm_back',\r\n  'right_lower_arm_front',\r\n  'right_lower_arm_back',\r\n  'left_hand',\r\n  'right_hand',\r\n  'torso_front',\r\n  'torso_back',\r\n  'left_upper_leg_front',\r\n  'left_upper_leg_back',\r\n  'right_upper_leg_front',\r\n  'right_upper_leg_back',\r\n  'left_lower_leg_front',\r\n  'left_lower_leg_back',\r\n  'right_lower_leg_front',\r\n  'right_lower_leg_back',\r\n  'left_feet',\r\n  'right_feet'\r\n];\r\n","/** @license See the LICENSE file. */\r\n\r\n// This code is auto-generated, do not modify this file!\r\nconst version = '2.0.5';\r\nexport {version};\r\n"],"names":["tf.oneHot","tf.tidy","tf.scalar","tf.range","tf.util","tslib_1.__extends","tf.div","tf.tensor","tf.backend","getBackend","tf.Tensor","tf.browser","tf.pad3d","tf.image","tfconv.loadGraphModel"],"mappings":"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"}